@page "/admin/mcp-services"
@layout MainLayout
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Contracts.Models
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject IMcpServiceConfigClientService ServiceConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc

<PageTitle>@Loc["AdminMcpServices"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner -->
    <MudItem xs="12">
        <MudCard Elevation="2" Class="m3-mb-xl m3-hero-card">
            <MudCardContent Class="pa-6">
                <div class="d-flex justify-space-between align-center flex-wrap" Style="gap: 1rem;">
                    <div>
                        <MudText Typo="Typo.h4" Class="m3-mb-sm m3-hero-title" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mr-2 m3-hero-icon" /> @Loc["AdminMcpServices"]
                        </MudText>
                        <MudText Typo="Typo.body1" Class="m3-hero-subtitle" Style="font-weight: 400;">
                            @if (_totalCount > 0)
                            {
                                <span>@Loc["TotalMcpServices", _totalCount]</span>
                            }
                            else
                            {
                                <span>@Loc["ManageAllMcpServices"]</span>
                            }
                        </MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Search and Sort -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="1">
            <MudGrid>
                <MudItem xs="12" sm="8">
                    <MudTextField @bind-Value="_searchTerm"
                                  Label="@Loc["Search"]"
                                  Placeholder="@Loc["SearchMcpServices"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="500"
                                  OnDebounceIntervalElapsed="OnSearchChanged"
                                  Clearable="true"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect Value="_sortBy"
                               Label="@Loc["SortBy"]"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               T="string"
                               ValueChanged="OnSortChanged">
                        <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                        <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                        <MudSelectItem Value="@("UpdatedAt")">@Loc["UpdatedDate"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <!-- Services Grid with Load More -->
    <MudItem xs="12">
        <div style="height: calc(100vh - 400px); overflow-y: auto; overflow-x: hidden;">
            <MudGrid Spacing="3" Class="px-4 py-2">
                @if (_initialLoading)
                {
                    for (var i = 0; i < PageSize; i++)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Style="height: 350px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                }
                else if (_services.Any())
                {
                    @foreach (var service in _services)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Elevation="2" Class="m3-card" Style="height: 100%; display: flex; flex-direction: column;">
                                <MudCardHeader Class="pb-2">
                                    <CardHeaderContent>
                                        <div class="d-flex align-center mb-2">
                                            <MudIcon Icon="@Icons.Material.Outlined.Settings" Class="mr-2" Color="Color.Primary" />
                                            <MudText Typo="Typo.h6" Style="font-weight: 600; flex-grow: 1;">@service.Name</MudText>
                                        </div>
                                        @if (service.IsPublic)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Public">
                                                @Loc["PublicService"]
                                            </MudChip>
                                        }
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent Class="pt-2" Style="flex-grow: 1;">
                                    @if (!string.IsNullOrEmpty(service.Description))
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3" Style="min-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                            @service.Description
                                        </MudText>
                                    }

                                    <MudDivider Class="my-3" />

                                    <!-- Creator Info -->
                                    @if (service.Creator != null)
                                    {
                                        <div class="d-flex align-center mb-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" Color="Color.Secondary" />
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @Loc["Creator"]: @(service.Creator.DisplayName ?? service.Creator.UserName ?? service.Creator.UserId)
                                            </MudText>
                                        </div>
                                    }

                                    <!-- Tools Count -->
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Class="mr-2" Color="Color.Info" />
                                        <MudText Typo="Typo.body2">
                                            @Loc["ToolsCount", service.Tools.Count]
                                        </MudText>
                                    </div>

                                    <!-- Protocol -->
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Cable" Size="Size.Small" Class="mr-2" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @Loc["Protocol"]: @(service.Protocol ?? "stdio")
                                        </MudText>
                                    </div>

                                    <!-- Created Date -->
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @service.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                        </MudText>
                                    </div>
                                </MudCardContent>
                                <MudCardActions Class="pt-0">
                                    <MudButton Variant="Variant.Filled"
                                              Color="Color.Primary"
                                              StartIcon="@Icons.Material.Filled.Sync"
                                              OnClick="@(() => SyncServiceToolsAsync(service))"
                                              Disabled="@IsSyncing(service.Id)"
                                              Size="Size.Small"
                                              FullWidth="true">
                                        @if (IsSyncing(service.Id))
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                            <span>@Loc["Syncing"]</span>
                                        }
                                        else
                                        {
                                            <span>@Loc["SyncTools"]</span>
                                        }
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
                            <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                                     Style="font-size: 120px;" 
                                     Color="Color.Default" 
                                     Class="mb-4" />
                            <MudText Typo="Typo.h5" Class="mb-2">
                                @(string.IsNullOrWhiteSpace(_searchTerm) ? Loc["NoServicesYet"] : Loc["NoServicesFound"])
                            </MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @(string.IsNullOrWhiteSpace(_searchTerm) ? Loc["ManageAllMcpServices"] : Loc["NoMatchingServices", _searchTerm])
                            </MudText>
                            @if (!string.IsNullOrWhiteSpace(_searchTerm))
                            {
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Clear"
                                           OnClick="ClearSearch">
                                    @Loc["ClearSearch"]
                                </MudButton>
                            }
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            @if (_loadingMore)
            {
                <MudGrid Spacing="3" Class="px-4 py-2">
                    @for (var i = 0; i < 3; i++)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Style="height: 350px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }

            @if (_hasMoreData && !_loadingMore && !_initialLoading)
            {
                <div class="load-more-container d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               Class="m3-button load-more-button"
                               OnClick="LoadMoreAsync">
                        @Loc["LoadMore"]
                    </MudButton>
                </div>
            }
        </div>
    </MudItem>
</MudGrid>

@code {
    private List<McpServiceConfigDto> _services = new();
    private bool _initialLoading = true;
    private bool _loadingMore = false;
    private int _currentPage = 1;
    private bool _hasMoreData = true;
    private int _totalCount = 0;
    private string _searchTerm = string.Empty;
    private string _sortBy = "CreatedAt";

    private readonly HashSet<string> _syncingServices = new();

    private const int PageSize = 12;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }
    private async Task LoadServicesAsync(bool resetList)
    {
        if (resetList)
        {
            _currentPage = 1;
            _services.Clear();
            _hasMoreData = true;
        }

        try
        {
            var request = new PagedRequest
            {
                Page = _currentPage,
                PageSize = PageSize,
                SearchTerm = _searchTerm,
                SortBy = _sortBy,
                SortOrder = "desc"
            };

            var result = await ServiceConfigService.GetAllServicesForAdminAsync(request);
            if (resetList)
            {
                _services = result.Items.ToList();
            }
            else
            {
                _services.AddRange(result.Items);
            }

            _totalCount = result.TotalCount;
            _hasMoreData = _currentPage < result.TotalPages;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["ErrorLoadingServices"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_loadingMore || !_hasMoreData)
        {
            return;
        }

        _loadingMore = true;
        StateHasChanged();

        try
        {
            _currentPage++;
            await LoadServicesAsync(resetList: false);
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged()
    {
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSortChanged(string newSortBy)
    {
        _sortBy = newSortBy;
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearSearch()
    {
        _searchTerm = string.Empty;
        _ = OnSearchChanged();
    }

    private bool IsSyncing(string serviceId)
    {
        return _syncingServices.Contains(serviceId);
    }

    private async Task SyncServiceToolsAsync(McpServiceConfigDto service)
    {
        if (_syncingServices.Contains(service.Id))
            return;

        try
        {
            _syncingServices.Add(service.Id);
            StateHasChanged();

            await ServiceConfigService.AdminSyncToolsAsync(service.Id);
            
            Snackbar.Add(Loc["SyncToolsSuccess", service.Name], Severity.Success);

            // Refresh the service data
            _initialLoading = true;
            StateHasChanged();
            await LoadServicesAsync(resetList: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(Loc["SyncToolsError", service.Name, ex.Message], Severity.Error);
        }
        finally
        {
            _syncingServices.Remove(service.Id);
            StateHasChanged();
        }
    }
}
