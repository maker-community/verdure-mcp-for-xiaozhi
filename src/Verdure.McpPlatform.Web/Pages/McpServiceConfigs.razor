@page "/mcp-services"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Contracts.Models
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.Authorization
@using Verdure.McpPlatform.Web.Extensions
@inject IMcpServiceConfigClientService ServiceConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@Loc["McpServices"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner -->
    <MudItem xs="12">
        <MudCard Elevation="2" Style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
            <MudCardContent Class="pa-6">
                <div class="d-flex justify-space-between align-center flex-wrap" Style="gap: 1rem;">
                    <div>
                        <MudText Typo="Typo.h4" Class="m3-mb-sm" Style="font-weight: 600; color: #FFFFFF;">
                            <MudIcon Icon="@Icons.Material.Outlined.Settings" Class="mr-2" Style="color: #FFFFFF;" /> @Loc["McpServices"]
                        </MudText>
                        <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); font-weight: 400;">
                            @if (_totalCount > 0)
                            {
                                <span>@Loc["TotalMcpServices", _totalCount]</span>
                            }
                            else
                            {
                                <span>@Loc["ManageMcpServices"]</span>
                            }
                        </MudText>
                    </div>
                    <MudButton Href="/mcp-services/create" 
                              Variant="Variant.Filled" 
                              Style="background: #FFFFFF; color: #1976D2;"
                              StartIcon="@Icons.Material.Filled.Add"
                              Size="Size.Large"
                              Class="m3-button-lg">
                        @Loc["AddMcpService"]
                    </MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Tabs and Search -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="1">
            <MudGrid>
                <!-- Tabs -->
                <MudItem xs="12" md="6">
                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" 
                             ActivePanelIndex="@_activeTabIndex"
                             ActivePanelIndexChanged="OnTabChanged"
                             PanelClass="pa-0">
                        <MudTabPanel Text="@Loc["MyServices"]" Icon="@Icons.Material.Filled.Person" />
                        <MudTabPanel Text="@Loc["PublicServices"]" Icon="@Icons.Material.Filled.Public" />
                    </MudTabs>
                </MudItem>
                
                <!-- Search and Sort -->
                <MudItem xs="12" md="6">
                    <MudGrid>
                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="_searchTerm"
                                          Label="@Loc["Search"]"
                                          Placeholder="@Loc["SearchMcpServices"]"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          DebounceInterval="500"
                                          OnDebounceIntervalElapsed="OnSearchChanged"
                                          Clearable="true"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudSelect Value="_sortBy"
                                       Label="@Loc["SortBy"]"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       T="string"
                                       ValueChanged="OnSortChanged">
                                <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                                <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                                <MudSelectItem Value="@("UpdatedAt")">@Loc["UpdatedDate"]</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <!-- Cards Container with Load More -->
    <MudItem xs="12">
        <div style="height: calc(100vh - 400px); overflow-y: auto; overflow-x: hidden;">
            <MudGrid Spacing="3" Class="px-4 py-2">
                @if (_initialLoading)
                {
                    for (var i = 0; i < PageSize; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 280px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                }
                else if (_services.Any())
                {
                    @foreach (var service in _services)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <ServiceConfigCard Service="@service"
                                               IsPublicView="@IsPublicTab"
                                               IsSyncing="@IsSyncing(service.Id)"
                                               ShowAdminActions="@_isAdmin"
                                               OnViewDetails="@(() => ViewDetails(service))"
                                               OnSyncTools="@(() => SyncTools(service))"
                                               OnEdit="@(() => EditService(service.Id))"
                                               OnDelete="@(() => DeleteService(service))"
                                               OnSetPublic="@(() => SetPublic(service))"
                                               OnSetPrivate="@(() => SetPrivate(service))"
                                               OnUseService="@(() => UsePublicService(service))" />
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
                            <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                                     Style="font-size: 120px;" 
                                     Color="Color.Default" 
                                     Class="mb-4" />
                            <MudText Typo="Typo.h5" Class="mb-2">
                                @(string.IsNullOrWhiteSpace(_searchTerm) 
                                    ? (IsPublicTab ? Loc["NoPublicServicesYet"] : Loc["NoServicesYet"])
                                    : Loc["NoServicesFound"])
                            </MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @(string.IsNullOrWhiteSpace(_searchTerm) 
                                    ? (IsPublicTab ? Loc["NoPublicServicesAvailable"] : Loc["CreateFirstService"])
                                    : Loc["NoMatchingServices", _searchTerm])
                            </MudText>
                            @if (string.IsNullOrWhiteSpace(_searchTerm) && !IsPublicTab)
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Href="/mcp-services/create">
                                    @Loc["CreateFirstService"]
                                </MudButton>
                            }
                            else if (!string.IsNullOrWhiteSpace(_searchTerm))
                            {
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Clear"
                                           OnClick="ClearSearch">
                                    @Loc["ClearSearch"]
                                </MudButton>
                            }
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            @if (_loadingMore)
            {
                <MudGrid Spacing="3" Class="px-4 py-2">
                    @for (var i = 0; i < 3; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 280px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }

            @if (_hasMoreData && !_loadingMore && !_initialLoading)
            {
                <div class="d-flex justify-center py-4">
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               OnClick="LoadMoreAsync"
                               Style="text-transform: none;">
                        @Loc["LoadMore"]
                    </MudButton>
                </div>
            }
        </div>
    </MudItem>
</MudGrid>

@code {
    // UI state
    private int _activeTabIndex = 0;
    private string _searchTerm = "";
    private string _sortBy = "CreatedAt";
    private string _sortOrder = "desc";
    private int _totalCount = 0;
    private bool _isAdmin = false;

    // Load more paging
    private const int PageSize = 12;
    private bool _initialLoading = true;
    private bool _loadingMore = false;
    private int _currentPage = 1;
    private bool _hasMoreData = true;
    private List<McpServiceConfigDto> _services = new();

    // Sync tools state - prevent concurrent clicks
    private readonly HashSet<string> _syncingServices = new();

    private bool IsPublicTab => _activeTabIndex == 1;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin using extension method
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAdmin = authState.User.IsAdmin(); // ‚úÖ ‰ΩøÁî®Êâ©Â±ïÊñπÊ≥ï

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadServicesAsync(bool resetList)
    {
        if (resetList)
        {
            _currentPage = 1;
            _services.Clear();
            _hasMoreData = true;
        }

        try
        {
            var request = new PagedRequest
            {
                Page = _currentPage,
                PageSize = PageSize,
                SearchTerm = _searchTerm,
                SortBy = _sortBy,
                SortOrder = _sortOrder
            };

            var result = IsPublicTab
                ? await ServiceConfigService.GetPublicServicesPagedAsync(request)
                : await ServiceConfigService.GetServicesPagedAsync(request);

            if (resetList)
            {
                _services = result.Items.ToList();
            }
            else
            {
                _services.AddRange(result.Items);
            }

            _totalCount = result.TotalCount;
            _hasMoreData = _currentPage < result.TotalPages;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading services: {ex.Message}");
            Snackbar.Add(string.Format(Loc["ErrorLoadingMcpServices"], ex.Message), Severity.Error);
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_loadingMore || !_hasMoreData)
        {
            return;
        }

        _loadingMore = true;
        StateHasChanged();

        try
        {
            _currentPage++;
            await LoadServicesAsync(resetList: false);
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged()
    {
        Console.WriteLine($"üîç Search changed: '{_searchTerm}'");
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSortChanged(string newSortBy)
    {
        Console.WriteLine($"üîÑ Sort changed: {newSortBy}");
        _sortBy = newSortBy;
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private void ClearSearch()
    {
        _searchTerm = "";
        _ = OnSearchChanged();
    }

    private async Task ViewDetails(McpServiceConfigDto service)
    {
        // Â¶ÇÊûúÊòØÂÖ¨ÂºÄÊúçÂä°ÔºåÊòæÁ§∫ÂØπËØùÊ°Ü
        if (IsPublicTab)
        {
            var parameters = new DialogParameters<PublicServiceDetailDialog>
            {
                { x => x.Service, service }
            };

            var options = new DialogOptions 
            { 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<PublicServiceDetailDialog>(
                service.Name, 
                parameters, 
                options);
        }
        else
        {
            // ‰∏™‰∫∫ÊúçÂä°ÔºåË∑≥ËΩ¨Âà∞ËØ¶ÊÉÖÈ°µÈù¢
            Navigation.NavigateTo($"/mcp-services/{service.Id}");
        }
    }

    private void UsePublicService(McpServiceConfigDto service)
    {
        // Ë∑≥ËΩ¨Âà∞ÊúçÂä°ÁªëÂÆöÂàõÂª∫È°µÈù¢
        Navigation.NavigateTo($"/service-bindings/create?publicServiceId={service.Id}");
    }

    private void EditService(string id)
    {
        Navigation.NavigateTo($"/mcp-services/edit/{id}");
    }

    private bool IsSyncing(string serviceId)
    {
        return _syncingServices.Contains(serviceId);
    }

    private async Task SyncTools(McpServiceConfigDto service)
    {
        // Èò≤Ê≠¢Âπ∂ÂèëÊâßË°å
        if (_syncingServices.Contains(service.Id))
        {
            Console.WriteLine($"‚è∏Ô∏è Already syncing service {service.Id}, skipping...");
            return;
        }

        try
        {
            // Ê∑ªÂä†Âà∞ÂêåÊ≠•‰∏≠ÁöÑÊúçÂä°ÈõÜÂêà
            _syncingServices.Add(service.Id);
            StateHasChanged(); // Êõ¥Êñ∞UIÔºåÁ¶ÅÁî®ÊåâÈíÆ

            await ServiceConfigService.SyncToolsAsync(service.Id);
            Snackbar.Add(string.Format(Loc["ToolsSyncedSuccess"], service.Name), Severity.Success);
            
            // Reload to get updated tool list
            _initialLoading = true;
            StateHasChanged();
            await LoadServicesAsync(resetList: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorSyncingTools"], ex.Message), Severity.Error);
        }
        finally
        {
            // ‰ªéÂêåÊ≠•‰∏≠ÁöÑÊúçÂä°ÈõÜÂêàÁßªÈô§
            _syncingServices.Remove(service.Id);
            StateHasChanged(); // Êõ¥Êñ∞UIÔºåÂêØÁî®ÊåâÈíÆ
        }
    }

    private async Task DeleteService(McpServiceConfigDto service)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["ConfirmDelete"],
            Loc["ConfirmDeleteMcpService", service.Name],
            yesText: Loc["Delete"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await ServiceConfigService.DeleteServiceAsync(service.Id);
                Snackbar.Add(string.Format(Loc["McpServiceDeletedSuccess"], service.Name), Severity.Success);
                _initialLoading = true;
                StateHasChanged();
                await LoadServicesAsync(resetList: true);
                _initialLoading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(Loc["ErrorDeletingMcpService"], ex.Message), Severity.Error);
            }
        }
    }

    private async Task SetPublic(McpServiceConfigDto service)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["ConfirmSetPublic"],
            Loc["ConfirmSetPublicMessage", service.Name],
            yesText: Loc["Confirm"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await ServiceConfigService.SetPublicAsync(service.Id);
                Snackbar.Add(string.Format(Loc["McpServiceSetPublicSuccess"], service.Name), Severity.Success);
                _initialLoading = true;
                StateHasChanged();
                await LoadServicesAsync(resetList: true);
                _initialLoading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(Loc["ErrorSettingPublic"], ex.Message), Severity.Error);
            }
        }
    }

    private async Task SetPrivate(McpServiceConfigDto service)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["ConfirmSetPrivate"],
            Loc["ConfirmSetPrivateMessage", service.Name],
            yesText: Loc["Confirm"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await ServiceConfigService.SetPrivateAsync(service.Id);
                Snackbar.Add(string.Format(Loc["McpServiceSetPrivateSuccess"], service.Name), Severity.Success);
                _initialLoading = true;
                StateHasChanged();
                await LoadServicesAsync(resetList: true);
                _initialLoading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(Loc["ErrorSettingPrivate"], ex.Message), Severity.Error);
            }
        }
    }
}
