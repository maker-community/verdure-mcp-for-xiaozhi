@page "/dashboard"
@layout MainLayout
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Web.Services
@inject IXiaozhiMcpEndpointClientService ServerService
@inject IMcpServiceBindingClientService BindingService
@inject IStringLocalizer<SharedResources> Loc
@inject IDateTimeFormatter DateTimeFormatter
@attribute [Authorize]

<PageTitle>@Loc["Dashboard"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner - 统一蓝色渐变 -->
    <MudItem xs="12">
        <MudCard Elevation="2" Style="background: linear-gradient(135deg, var(--m3-primary) 0%, var(--m3-primary-dark) 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
            <MudCardContent Class="pa-6">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Large" Style="color: #FFFFFF; margin-right: 12px;" />
                    <MudText Typo="Typo.h4" Style="color: #FFFFFF; font-weight: 600; margin: 0;">
                        @Loc["Dashboard"]
                    </MudText>
                </div>
                <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); margin-left: 48px;">
                    @Loc["DashboardOverview"]
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudCard Elevation="1" Class="m3-card" Style="background: linear-gradient(135deg, var(--m3-primary-container) 0%, var(--m3-secondary-container) 100%); border-left: 4px solid var(--m3-primary);">
            <MudCardContent Class="pa-6">
                <div class="d-flex flex-column flex-md-row justify-space-between align-center" style="gap: 16px;">
                    <div>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: var(--m3-primary-dark);">
                            @Loc["VerdureMcpServicePlatform"]
                        </MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(var(--m3-primary-rgb), 0.85); line-height: 1.6; margin-top: 8px;">
                            @Loc["VerdureMcpServicePlatformDesc"]
                        </MudText>
                    </div>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              Href="https://mcp.verdure-hiro.cn/"
                              Target="_blank"
                              EndIcon="@Icons.Material.Filled.OpenInNew"
                              Style="border-radius: 18px; text-transform: none;">
                        @Loc["GoToVerdureMcpServicePlatform"]
                    </MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- M3 统计卡片 - Primary Container -->
    <MudItem xs="12" sm="6" md="3" Style="display: flex;">
        <MudCard Elevation="1" Class="m3-stat-card m3-stat-card-primary m3-fade-in" Style="width: 100%;">
            <MudCardContent Class="d-flex flex-column justify-space-between" Style="height: 100%;">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--m3-primary-dark); font-weight: 600;">@_serverCount</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--m3-primary); font-weight: 500;">@Loc["XiaozhiMcpEndpoints"]</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Dns" Size="Size.Large" Style="color: var(--m3-primary);" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- M3 统计卡片 - Secondary Container -->
    <MudItem xs="12" sm="6" md="3" Style="display: flex;">
        <MudCard Elevation="1" Class="m3-stat-card m3-stat-card-secondary m3-fade-in" Style="animation-delay: 0.1s; width: 100%;">
            <MudCardContent Class="d-flex flex-column justify-space-between" Style="height: 100%;">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--m3-secondary-dark); font-weight: 600;">@_bindingCount</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--m3-secondary); font-weight: 500;">@Loc["TotalBindings"]</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Large" Style="color: var(--m3-secondary);" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- M3 统计卡片 - Success Container -->
    <MudItem xs="12" sm="6" md="3" Style="display: flex;">
        <MudCard Elevation="1" Class="m3-stat-card m3-stat-card-success m3-fade-in" Style="animation-delay: 0.2s; width: 100%;">
            <MudCardContent Class="d-flex flex-column justify-space-between" Style="height: 100%;">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--m3-success); font-weight: 600;">@_activeBindingCount</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(var(--m3-success-rgb), 0.9); font-weight: 500;">@Loc["ActiveBindings"]</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Style="color: var(--m3-success);" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- M3 统计卡片 - Warning Container -->
    <MudItem xs="12" sm="6" md="3" Style="display: flex;">
        <MudCard Elevation="1" Class="m3-stat-card m3-stat-card-warning m3-fade-in" Style="animation-delay: 0.3s; width: 100%;">
            <MudCardContent Class="d-flex flex-column justify-space-between" Style="height: 100%;">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--m3-warning); font-weight: 600;">@(_bindingCount - _activeBindingCount)</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(var(--m3-warning-rgb), 0.9); font-weight: 500;">@Loc["InactiveBindings"]</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.PauseCircle" Size="Size.Large" Style="color: var(--m3-warning);" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- M3 快速操作卡片 -->
    <MudItem xs="12">
        <MudCard Elevation="1" Class="m3-card">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6" Style="font-weight: 500;">@Loc["QuickActions"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <div class="d-flex m3-gap-lg flex-wrap">
                    <MudButton Href="/connections/create" 
                              Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              Class="m3-button">
                        @Loc["AddXiaozhiMcpEndpoint"]
                    </MudButton>
                    <MudButton Href="/service-bindings/create" 
                              Variant="Variant.Filled" 
                              Color="Color.Secondary" 
                              StartIcon="@Icons.Material.Filled.Link"
                              Class="m3-button">
                        @Loc["CreateBinding"]
                    </MudButton>
                    <MudButton Href="/connections" 
                              Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.List"
                              Class="m3-button">
                        @Loc["ViewAllConnections"]
                    </MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudCard Elevation="1" Class="m3-card">
            <MudCardHeader>
                <CardHeaderContent>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                        <MudText Typo="Typo.h6" Style="font-weight: 500;">@Loc["RecentServers"]</MudText>
                    </div>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent Class="pa-0">
                @if (_loading)
                {
                    <div class="pa-4">
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                    </div>
                }
                else if (_recentServers.Any())
                {
                    <MudList T="string" Class="pa-0">
                        @foreach (var server in _recentServers.Take(5))
                        {
                            <MudListItem T="string" Class="px-4 py-3">
                                <div class="d-flex flex-column flex-sm-row justify-space-between w-100" style="gap: 16px;">
                                    <!-- 左侧信息区域 -->
                                    <div class="d-flex flex-column flex-grow-1" style="min-width: 0;">
                                        <div class="d-flex align-center mb-1" style="gap: 8px;">
                                            <MudIcon Icon="@Icons.Material.Filled.Dns" Size="Size.Small" Color="Color.Primary" />
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                @server.Name
                                            </MudText>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(server.Description))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2" 
                                                     Style="line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">
                                                @server.Description
                                            </MudText>
                                        }
                                        <div class="d-flex align-center flex-wrap" style="gap: 12px;">
                                            <div class="d-flex align-center" style="gap: 4px;">
                                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Info" />
                                                <MudText Typo="Typo.caption" Color="Color.Info">
                                                    @DateTimeFormatter.FormatRelativeTime(server.CreatedAt)
                                                </MudText>
                                            </div>
                                            @if (server.LastConnectedAt.HasValue)
                                            {
                                                <div class="d-flex align-center" style="gap: 4px;">
                                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Success" />
                                                    <MudText Typo="Typo.caption" Color="Color.Success">
                                                        @Loc["LastConnected"]: @DateTimeFormatter.FormatRelativeTime(server.LastConnectedAt)
                                                    </MudText>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- 右侧状态标签区域 -->
                                    <div class="d-flex flex-row flex-sm-column align-center align-sm-end justify-start" style="gap: 8px; flex-shrink: 0;">
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Icon="@Icons.Material.Filled.Link"
                                                 Color="Color.Info" 
                                                 Variant="Variant.Filled"
                                                 Style="font-weight: 500;">
                                            @server.ServiceBindings.Count @Loc["Bindings"]
                                        </MudChip>
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Icon="@(server.IsEnabled ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                                 Color="@(server.IsEnabled ? Color.Success : Color.Default)" 
                                                 Variant="Variant.Outlined">
                                            @(server.IsEnabled ? Loc["Enabled"] : Loc["Disabled"])
                                        </MudChip>
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Icon="@(server.IsConnected ? Icons.Material.Filled.CloudDone : Icons.Material.Filled.CloudOff)"
                                                 Color="@(server.IsConnected ? Color.Success : Color.Error)" 
                                                 Variant="Variant.Outlined">
                                            @(server.IsConnected ? Loc["Connected"] : Loc["Disconnected"])
                                        </MudChip>
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <div class="pa-4">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">@Loc["NoServersYet"]</MudAlert>
                    </div>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private bool _loading = true;
    private int _serverCount = 0;
    private int _bindingCount = 0;
    private int _activeBindingCount = 0;
    private List<XiaozhiMcpEndpointDto> _recentServers = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
    }

    private async Task LoadDashboardDataAsync()
    {
        try
        {
            _loading = true;
            
            var servers = await ServerService.GetServersAsync();
            _recentServers = servers.OrderByDescending(s => s.CreatedAt).ToList();
            _serverCount = _recentServers.Count;
            _bindingCount = _recentServers.Sum(s => s.ServiceBindings.Count);
            _activeBindingCount = _recentServers.SelectMany(s => s.ServiceBindings).Count(b => b.IsActive);
        }
        catch (Exception)
        {
            // User not authenticated or error loading data
            _serverCount = 0;
            _bindingCount = 0;
            _activeBindingCount = 0;
            _recentServers = new List<XiaozhiMcpEndpointDto>();
        }
        finally
        {
            _loading = false;
        }
    }
}
