@page "/connections"
@layout MainLayout
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Contracts.Models
@using Verdure.McpPlatform.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@inject IXiaozhiMcpEndpointClientService ServerService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc
@inject IJSRuntime JS
@implements IDisposable
@attribute [Authorize]

<PageTitle>@Loc["XiaozhiMcpEndpoints"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- Responsive Hero Banner -->
    <MudItem xs="12">
        <PageHeader Icon="@Icons.Material.Outlined.Dns"
                    Title="@Loc["XiaozhiMcpEndpoints"]"
                    TotalCount="_totalCount"
                    CountMessage="@Loc["TotalConnections", _totalCount]"
                    EmptyMessage="@Loc["ManageConnections"]"
                    ActionHref="/connections/create"
                    ActionText="@Loc["AddConnection"]"
                    IsSmallScreen="_isSmallScreen" />
    </MudItem>

    <!-- Responsive Search and Filters -->
    <MudItem xs="12">
        <SearchFilterBar SearchTerm="@_searchTerm"
                         SearchTermChanged="@(value => _searchTerm = value)"
                         SortBy="@_sortBy"
                         SortByChanged="@(value => _sortBy = value)"
                         SortOptions="@_sortOptions"
                         SearchLabel="@Loc["Search"]"
                         SearchPlaceholder="@Loc["SearchConnections"]"
                         SortByLabel="@Loc["SortBy"]"
                         OnSearchChanged="@OnSearchChanged"
                         OnSortChanged="@OnSortChangedAsync"
                         IsSmallScreen="_isSmallScreen" />
    </MudItem>

    <!-- Cards Container with Load More -->
    <MudItem xs="12">
        <div style="height: calc(100vh - @(_isSmallScreen ? "280px" : "350px")); overflow-y: auto; overflow-x: hidden;">
            <MudGrid Spacing="@(_isSmallScreen ? 2 : 3)" Class="@(_isSmallScreen ? "px-2 py-1" : "px-4 py-2")">
                @if (_initialLoading)
                {
                    for (var i = 0; i < PageSize; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 200px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                }
                else if (_connections.Any())
                {
                    @foreach (var server in _connections)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <ConnectionCard Connection="@server"
                                            OnEdit="@(() => HandleEdit(server))"
                                            OnDelete="@(() => HandleDelete(server))"
                                            OnEnable="@(() => HandleEnable(server))"
                                            OnDisable="@(() => HandleDisable(server))"
                                            OnViewBindings="@(() => HandleViewBindings(server))" />
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
                            <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                                     Style="font-size: 120px;" 
                                     Color="Color.Default" 
                                     Class="mb-4" />
                            <MudText Typo="Typo.h5" Class="mb-2">
                                @(string.IsNullOrWhiteSpace(_searchTerm) ? Loc["NoConnectionsYet"] : Loc["NoConnectionsFound"])
                            </MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @(string.IsNullOrWhiteSpace(_searchTerm) 
                                    ? Loc["CreateFirstConnection"] 
                                    : Loc["NoMatchingConnections", _searchTerm])
                            </MudText>
                            @if (string.IsNullOrWhiteSpace(_searchTerm))
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Href="/connections/create">
                                    @Loc["CreateFirstConnection"]
                                </MudButton>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Clear"
                                           OnClick="ClearSearch">
                                    @Loc["ClearSearch"]
                                </MudButton>
                            }
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            @if (_loadingMore)
            {
                <MudGrid Spacing="@(_isSmallScreen ? 2 : 3)" Class="@(_isSmallScreen ? "px-2 py-1" : "px-4 py-2")">
                    @for (var i = 0; i < 3; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 200px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }

            @if (_hasMoreData && !_loadingMore && !_initialLoading)
            {
                <div class="load-more-container d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               Class="m3-button load-more-button"
                               OnClick="LoadMoreAsync">
                        @Loc["LoadMore"]
                    </MudButton>
                </div>
            }
        </div>
    </MudItem>
</MudGrid>

@code {
    // UI state
    private string _searchTerm = "";
    private string _sortBy = "CreatedAt";
    private string _sortOrder = "desc";
    private int _totalCount = 0;
    private bool _isSmallScreen = false;

    // Load more paging
    private const int PageSize = 12;
    private bool _initialLoading = true;
    private bool _loadingMore = false;
    private int _currentPage = 1;
    private bool _hasMoreData = true;
    private List<XiaozhiMcpEndpointDto> _connections = new();
    
    // Browser resize detection
    private DotNetObjectReference<Connections>? _dotNetRef;

    // Sort options for SearchFilterBar
    private List<SearchFilterBar.SortOption> _sortOptions = new();

    protected override void OnInitialized()
    {
        // Initialize sort options
        _sortOptions = new List<SearchFilterBar.SortOption>
        {
            new() { Value = "CreatedAt", Text = Loc["CreatedDate"] },
            new() { Value = "Name", Text = Loc["Name"] },
            new() { Value = "Address", Text = Loc["Address"] },
            new() { Value = "Status", Text = Loc["Status"] }
        };
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await CheckScreenSize();
        }
    }

    [JSInvokable]
    public void OnResize(int width)
    {
        var wasSmallScreen = _isSmallScreen;
        _isSmallScreen = width < 600; // MudBlazor's xs/sm breakpoint
        
        if (wasSmallScreen != _isSmallScreen)
        {
            StateHasChanged();
        }
    }

    private async Task CheckScreenSize()
    {
        try
        {
            // Try to get initial screen size
            var width = await JS.InvokeAsync<int>("eval", "window.innerWidth");
            _isSmallScreen = width < 600;
            StateHasChanged();
        }
        catch
        {
            // Fallback to default
            _isSmallScreen = false;
        }
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    private async Task LoadConnectionsAsync(bool resetList)
    {
        if (resetList)
        {
            _currentPage = 1;
            _connections.Clear();
            _hasMoreData = true;
        }

        try
        {
            var request = new PagedRequest
            {
                Page = _currentPage,
                PageSize = PageSize,
                SearchTerm = _searchTerm,
                SortBy = _sortBy,
                SortOrder = _sortOrder
            };

            var result = await ServerService.GetServersPagedAsync(request);
            if (resetList)
            {
                _connections = result.Items.ToList();
            }
            else
            {
                _connections.AddRange(result.Items);
            }

            _totalCount = result.TotalCount;
            _hasMoreData = _currentPage < result.TotalPages;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_loadingMore || !_hasMoreData)
        {
            return;
        }

        _loadingMore = true;
        StateHasChanged();

        try
        {
            _currentPage++;
            await LoadConnectionsAsync(resetList: false);
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// ÊêúÁ¥¢Ê°ÜÂèòÂåñÊó∂Âà∑Êñ∞ËôöÊãüÂåñÂàóË°®
    /// </summary>
    private async Task OnSearchChanged()
    {
        Console.WriteLine($"üîç Search changed: '{_searchTerm}'");
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// ÊéíÂ∫èÂèòÂåñÊó∂Âà∑Êñ∞ËôöÊãüÂåñÂàóË°®
    /// </summary>
    private async Task OnSortChangedAsync()
    {
        Console.WriteLine($"üìä Sort changed: {_sortBy}");
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private void ClearSearch()
    {
        _searchTerm = "";
        _ = OnSearchChanged();
    }

    private void HandleEdit(XiaozhiMcpEndpointDto server)
    {
        Navigation.NavigateTo($"/connections/edit/{server.Id}");
    }

    private async Task HandleDelete(XiaozhiMcpEndpointDto server)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["DeleteConnection"],
            Loc["DeleteConnectionConfirm", server.Name],
            yesText: Loc["Delete"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await ServerService.DeleteServerAsync(server.Id);
                _totalCount--;
                Snackbar.Add(Loc["DeletedSuccessfully", server.Name], Severity.Success);
                _initialLoading = true;
                StateHasChanged();
                await LoadConnectionsAsync(resetList: true);
                _initialLoading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleEnable(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.EnableServerAsync(server.Id);
            Snackbar.Add(Loc["EnabledSuccessfully", server.Name], Severity.Success);
            _initialLoading = true;
            StateHasChanged();
            await LoadConnectionsAsync(resetList: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleDisable(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.DisableServerAsync(server.Id);
            Snackbar.Add(Loc["DisabledSuccessfully", server.Name], Severity.Success);
            _initialLoading = true;
            StateHasChanged();
            await LoadConnectionsAsync(resetList: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private void HandleViewBindings(XiaozhiMcpEndpointDto server)
    {
        Navigation.NavigateTo($"/connections/{server.Id}/service-bindings");
    }
}
