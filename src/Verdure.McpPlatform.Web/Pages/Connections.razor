@page "/connections"
@layout MainLayout
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Contracts.Models
@using Verdure.McpPlatform.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Microsoft.JSInterop
@inject IXiaozhiMcpEndpointClientService ServerService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc
@inject IJSRuntime JS
@implements IAsyncDisposable
@attribute [Authorize]

<PageTitle>@Loc["XiaozhiMcpEndpoints"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner - è“è‰²èƒŒæ™¯ -->
    <MudItem xs="12">
        <MudCard Elevation="2" Style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
            <MudCardContent Class="pa-6">
                <div class="d-flex justify-space-between align-center flex-wrap" Style="gap: 1rem;">
                    <div>
                        <MudText Typo="Typo.h4" Class="m3-mb-sm" Style="font-weight: 600; color: #FFFFFF;">
                            <MudIcon Icon="@Icons.Material.Outlined.Dns" Class="mr-2" Style="color: #FFFFFF;" /> @Loc["XiaozhiMcpEndpoints"]
                        </MudText>
                        <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); font-weight: 400;">
                            @if (_totalCount > 0)
                            {
                                <span>@Loc["TotalConnections", _totalCount]</span>
                            }
                            else
                            {
                                <span>@Loc["ManageConnections"]</span>
                            }
                        </MudText>
                    </div>
                    <MudButton Href="/connections/create" 
                              Variant="Variant.Filled" 
                              Style="background: #FFFFFF; color: #1976D2;"
                              StartIcon="@Icons.Material.Filled.Add"
                              Size="Size.Large"
                              Class="m3-button-lg">
                        @Loc["AddConnection"]
                    </MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Search and Filters -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="1">
            <MudGrid>
                <MudItem xs="12" sm="6" md="8">
                    <MudTextField @bind-Value="_searchTerm"
                                  Label="@Loc["Search"]"
                                  Placeholder="@Loc["SearchConnections"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="500"
                                  OnDebounceIntervalElapsed="OnSearchChanged"
                                  Clearable="true"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="_sortBy"
                               Label="@Loc["SortBy"]"
                               Variant="Variant.Outlined"
                               T="string"
                               ValueChanged="OnSortChanged">
                        <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                        <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                        <MudSelectItem Value="@("Address")">@Loc["Address"]</MudSelectItem>
                        <MudSelectItem Value="@("Status")">@Loc["Status"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <!-- Cards Container with Infinite Scroll -->
    <MudItem xs="12">
        <div id="connections-scroll-container" 
             style="height: calc(100vh - 400px); overflow-y: auto; overflow-x: hidden;">
            
            @if (_loading && _servers.Count == 0)
            {
                <!-- Initial Loading Skeleton -->
                <MudGrid Spacing="3" Class="pa-4">
                    @for (int i = 0; i < 8; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 200px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else if (_servers.Count == 0)
            {
                <!-- No Data -->
                <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
                    <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                             Style="font-size: 120px;" 
                             Color="Color.Default" 
                             Class="mb-4" />
                    <MudText Typo="Typo.h5" Class="mb-2">
                        @(string.IsNullOrWhiteSpace(_searchTerm) ? Loc["NoConnectionsYet"] : Loc["NoConnectionsFound"])
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @(string.IsNullOrWhiteSpace(_searchTerm) 
                            ? Loc["CreateFirstConnection"] 
                            : Loc["NoMatchingConnections", _searchTerm])
                    </MudText>
                    @if (string.IsNullOrWhiteSpace(_searchTerm))
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Href="/connections/create">
                            @Loc["CreateFirstConnection"]
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   OnClick="ClearSearch">
                            @Loc["ClearSearch"]
                        </MudButton>
                    }
                </MudPaper>
            }
            else
            {
                <!-- Cards Grid -->
                <MudGrid Spacing="3" Class="pa-4">
                    @foreach (var server in _servers)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <ConnectionCard Connection="@server"
                                            OnEdit="@(() => HandleEdit(server))"
                                            OnDelete="@(() => HandleDelete(server))"
                                            OnEnable="@(() => HandleEnable(server))"
                                            OnDisable="@(() => HandleDisable(server))"
                                            OnViewBindings="@(() => HandleViewBindings(server))" />
                        </MudItem>
                    }
                </MudGrid>

                <!-- Loading More Indicator -->
                @if (_loadingMore)
                {
                    <div class="d-flex justify-center pa-4">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    </div>
                }

                <!-- Scroll Sentinel -->
                @if (_hasMoreData && !_loadingMore)
                {
                    <div id="scroll-sentinel" style="height: 1px;"></div>
                }
            }
        </div>
    </MudItem>
</MudGrid>

@code {
    // Data
    private List<XiaozhiMcpEndpointDto> _servers = new();

    // UI state
    private string _searchTerm = "";
    private string _sortBy = "CreatedAt";
    private string _sortOrder = "desc";
    private int _totalCount = 0;
    private bool _loading = false;
    private bool _loadingMore = false;
    private bool _hasMoreData = true;

    // Pagination
    private int _currentPage = 1;
    private const int _pageSize = 12;

    // JavaScript interop
    private IJSObjectReference? _module;
    private DotNetObjectReference<Connections>? _dotNetHelper;

    protected override async Task OnInitializedAsync()
    {
        await LoadServersAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/infinite-scroll.js");
                _dotNetHelper = DotNetObjectReference.Create(this);
                await _module.InvokeVoidAsync("initializeInfiniteScroll", "scroll-sentinel", _dotNetHelper);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?Failed to initialize infinite scroll: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task LoadMoreAsync()
    {
        if (_hasMoreData && !_loadingMore)
        {
            await LoadServersAsync(loadMore: true);
        }
    }

    private async Task LoadServersAsync(bool loadMore = false)
    {
        if (_loading || _loadingMore) return;

        if (loadMore)
        {
            _loadingMore = true;
            _currentPage++;
        }
        else
        {
            _loading = true;
            _currentPage = 1;
            _servers.Clear();
        }

        try
        {
            Console.WriteLine($"ðŸ”„ LoadServersAsync: Page={_currentPage}, PageSize={_pageSize}, LoadMore={loadMore}");

            var pagedRequest = new PagedRequest
            {
                Page = _currentPage,
                PageSize = _pageSize,
                SearchTerm = _searchTerm,
                SortBy = _sortBy,
                SortOrder = _sortOrder
            };

            var result = await ServerService.GetServersPagedAsync(pagedRequest);
            
            _totalCount = result.TotalCount;
            
            if (loadMore)
            {
                _servers.AddRange(result.Items);
            }
            else
            {
                _servers = result.Items.ToList();
            }

            _hasMoreData = _servers.Count < _totalCount;

            Console.WriteLine($"ï¿½?Loaded: Page={_currentPage}, Items={result.Items.Count()}, Total={_servers.Count}/{_totalCount}, HasMore={_hasMoreData}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ï¿½?Error: {ex.Message}");
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged()
    {
        Console.WriteLine($"ðŸ” Search changed: '{_searchTerm}'");
        await LoadServersAsync();
    }

    private async Task OnSortChanged(string newSortBy)
    {
        Console.WriteLine($"ï¿½?Sort changed: {_sortBy} ï¿½?{newSortBy}");
        _sortBy = newSortBy;
        await LoadServersAsync();
    }

    private void ClearSearch()
    {
        _searchTerm = "";
        _ = LoadServersAsync();
    }

    private void HandleEdit(XiaozhiMcpEndpointDto server)
    {
        Navigation.NavigateTo($"/connections/edit/{server.Id}");
    }

    private async Task HandleDelete(XiaozhiMcpEndpointDto server)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["DeleteConnection"],
            Loc["DeleteConnectionConfirm", server.Name],
            yesText: Loc["Delete"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await ServerService.DeleteServerAsync(server.Id);
                _totalCount--;
                Snackbar.Add(Loc["DeletedSuccessfully", server.Name], Severity.Success);
                
                // Refresh the virtualized list
                await LoadServersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleEnable(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.EnableServerAsync(server.Id);
            Snackbar.Add(Loc["EnabledSuccessfully", server.Name], Severity.Success);
            
            // Refresh the virtualized list
            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleDisable(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.DisableServerAsync(server.Id);
            Snackbar.Add(Loc["DisabledSuccessfully", server.Name], Severity.Success);
            
            // Refresh the virtualized list
            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private void HandleViewBindings(XiaozhiMcpEndpointDto server)
    {
        Navigation.NavigateTo($"/connections/{server.Id}/bindings");
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            await _module.DisposeAsync();
        }
        _dotNetHelper?.Dispose();
    }
}
