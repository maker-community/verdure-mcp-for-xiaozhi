@page "/settings"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Microsoft.AspNetCore.Components.Authorization
@using Verdure.McpPlatform.Web.Extensions
@using Verdure.McpPlatform.Contracts.DTOs
@inject IStringLocalizer<SharedResources> Loc
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IMcpServiceConfigClientService ServiceConfigService
@inject ISnackbar Snackbar

<PageTitle>@Loc["Settings"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner - 统一蓝色渐变 -->
    <MudItem xs="12">
        <MudCard Elevation="2" Style="background: linear-gradient(135deg, var(--m3-primary) 0%, var(--m3-primary-dark) 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
            <MudCardContent Class="pa-6">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Large" Style="color: #FFFFFF; margin-right: 12px;" />
                    <MudText Typo="Typo.h4" Style="color: #FFFFFF; font-weight: 600; margin: 0;">
                        @Loc["Settings"]
                    </MudText>
                </div>
                <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); margin-left: 48px;">
                    @Loc["ManageAccountPreferences"]
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["AccountInformation"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <AuthorizeView>
                    <Authorized>
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@Loc["Username"]</MudText>
                                <MudText Typo="Typo.body1" Style="font-weight: 500;">@context.User.Identity?.Name</MudText>
                            </MudItem>
                            @if (context.User.Claims.Any())
                            {
                                <MudItem xs="12">
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">@Loc["UserClaims"]</MudText>
                                    <MudSimpleTable Dense="true" Style="overflow-x: auto;">
                                        <thead>
                                            <tr>
                                                <th>@Loc["ClaimType"]</th>
                                                <th>@Loc["Value"]</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var claim in context.User.Claims.Take(10))
                                            {
                                                <tr>
                                                    <td>@claim.Type</td>
                                                    <td style="word-break: break-all;">@claim.Value</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                </MudItem>
                            }
                        </MudGrid>
                    </Authorized>
                </AuthorizeView>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["About"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-2">
                    @Loc["AboutVerdurePlatform"]
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @Loc["ConfigureKeycloakSettings"]
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    @* Admin Actions - Only visible for Admin users *@
    @if (_isAdmin)
    {
        <MudItem xs="12" md="8">
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mr-2" Color="Color.Warning" />
                            <MudText Typo="Typo.h6">@Loc["AdminActions"]</MudText>
                        </div>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @Loc["AdminActionsDescription"]
                    </MudText>
                    
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Sync"
                              OnClick="SyncAllToolsAsync"
                              Disabled="_isSyncing"
                              Size="Size.Large">
                        @if (_isSyncing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Loc["SyncingAllTools"]</span>
                        }
                        else
                        {
                            <span>@Loc["SyncAllMcpTools"]</span>
                        }
                    </MudButton>
                    
                    @if (_syncResult != null)
                    {
                        <MudAlert Severity="@GetSyncResultSeverity()" Class="mt-4" Variant="Variant.Filled">
                            <MudText Typo="Typo.body1" Class="mb-2">
                                <strong>@Loc["SyncCompleted"]:</strong>
                            </MudText>
                            <MudText Typo="Typo.body2">
                                • @Loc["TotalProcessed"]: @_syncResult.TotalProcessed
                            </MudText>
                            <MudText Typo="Typo.body2">
                                • @Loc["SuccessCount"]: @_syncResult.SuccessCount
                            </MudText>
                            <MudText Typo="Typo.body2">
                                • @Loc["FailedCount"]: @_syncResult.FailedCount
                            </MudText>
                            
                            @if (_syncResult.FailedServices.Any())
                            {
                                <MudText Typo="Typo.body2" Class="mt-3 mb-1">
                                    <strong>@Loc["FailedServices"]:</strong>
                                </MudText>
                                <ul style="margin-top: 4px; padding-left: 20px;">
                                    @foreach (var failed in _syncResult.FailedServices)
                                    {
                                        <li>
                                            <strong>@failed.ServiceName</strong>: @failed.ErrorMessage
                                        </li>
                                    }
                                </ul>
                            }
                        </MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    }
</MudGrid>

@code {
    private bool _isAdmin = false;
    private bool _isSyncing = false;
    private SyncAllToolsResultDto? _syncResult = null;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAdmin = authState.User.IsAdmin();
    }

    private async Task SyncAllToolsAsync()
    {
        if (_isSyncing) return;

        try
        {
            _isSyncing = true;
            _syncResult = null;
            StateHasChanged();

            Snackbar.Add(Loc["StartingSyncAllTools"], Severity.Info);

            _syncResult = await ServiceConfigService.SyncAllToolsAsync();

            if (_syncResult.FailedCount == 0)
            {
                Snackbar.Add(Loc["SyncAllToolsSuccess", _syncResult.SuccessCount], Severity.Success);
            }
            else
            {
                Snackbar.Add(Loc["SyncAllToolsPartialSuccess", _syncResult.SuccessCount, _syncResult.FailedCount], Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(Loc["SyncAllToolsError", ex.Message], Severity.Error);
        }
        finally
        {
            _isSyncing = false;
            StateHasChanged();
        }
    }

    private Severity GetSyncResultSeverity()
    {
        if (_syncResult == null) return Severity.Info;
        if (_syncResult.FailedCount == 0) return Severity.Success;
        if (_syncResult.SuccessCount > 0) return Severity.Warning;
        return Severity.Error;
    }
}