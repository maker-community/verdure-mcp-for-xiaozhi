@page "/authentication/{action}"
@layout LandingLayout
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Web.Services
@inject IStringLocalizer<SharedResources> Loc
@inject IUserClientService UserClientService
@inject NavigationManager NavigationManager
@inject ILogger<Authentication> Logger

<RemoteAuthenticatorView Action="@Action" OnLogInSucceeded="OnLoginSucceeded">
    <LoggingIn>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #FFFFFF;">@Loc["SigningIn"]</MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255, 255, 255, 0.85);">@Loc["PleaseWaitAuthenticating"]</MudText>
        </div>
    </LoggingIn>
    
    <CompletingLoggingIn>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #FFFFFF;">@Loc["CompletingSignIn"]</MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255, 255, 255, 0.85);">@Loc["AlmostThere"]</MudText>
        </div>
    </CompletingLoggingIn>
    
    <LogOut>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudProgressCircular Color="Color.Warning" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #FFFFFF;">@Loc["SigningOutStatus"]</MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255, 255, 255, 0.85);">@Loc["YouAreBeingSignedOut"]</MudText>
        </div>
    </LogOut>
    
    <CompletingLogOut>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudProgressCircular Color="Color.Warning" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #FFFFFF;">@Loc["CompletingSignOut"]</MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255, 255, 255, 0.85);">@Loc["AlmostDone"]</MudText>
        </div>
    </CompletingLogOut>
    
    <LogInFailed>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudCard Elevation="4" Style="max-width: 500px; width: 100%;">
                <MudCardContent Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
                    <MudText Typo="Typo.h5" Class="mt-4 mb-2">@Loc["AuthenticationFailed"]</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @Loc["ErrorSigningIn"]
                    </MudText>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              Href="/login"
                              StartIcon="@Icons.Material.Filled.Refresh">
                        @Loc["TryAgain"]
                    </MudButton>
                </MudCardContent>
            </MudCard>
        </div>
    </LogInFailed>
    
    <LogOutFailed>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudCard Elevation="4" Style="max-width: 500px; width: 100%;">
                <MudCardContent Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
                    <MudText Typo="Typo.h5" Class="mt-4 mb-2">@Loc["SignOutFailed"]</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @Loc["ErrorSigningOut"]
                    </MudText>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              Href="/"
                              StartIcon="@Icons.Material.Filled.Home">
                        @Loc["GoToHome"]
                    </MudButton>
                </MudCardContent>
            </MudCard>
        </div>
    </LogOutFailed>
    
    <LogOutSucceeded>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 80vh;">
            <MudCard Elevation="4" Style="max-width: 500px; width: 100%;">
                <MudCardContent Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h5" Class="mt-4 mb-2">@Loc["SignedOutSuccessfully"]</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @Loc["SignedOutMessage"]
                    </MudText>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              Href="/login"
                              StartIcon="@Icons.Material.Filled.Login">
                        @Loc["SignInAgain"]
                    </MudButton>
                </MudCardContent>
            </MudCard>
        </div>
    </LogOutSucceeded>
</RemoteAuthenticatorView>

@code {
    [Parameter]
    public string? Action { get; set; }

    /// <summary>
    /// 登录成功后的回调，同步用户信息到 API
    /// </summary>
    private async Task OnLoginSucceeded(RemoteAuthenticationState state)
    {
        try
        {
            Logger.LogInformation("Login succeeded, syncing user to Identity database");

            // 调用 API 同步用户信息
            var result = await UserClientService.SyncCurrentUserAsync();

            if (result.Success)
            {
                Logger.LogInformation(
                    "User sync successful: UserId={UserId}, IsNewUser={IsNewUser}",
                    result.UserId, result.IsNewUser);

                // 可以在这里添加欢迎提示
                // if (result.IsNewUser)
                // {
                //     Snackbar.Add("Welcome! Your account has been created.", Severity.Success);
                // }
            }
            else
            {
                Logger.LogWarning("User sync failed: {Message}", result.Message);
                // 同步失败不阻止登录，用户仍然可以使用应用
                // 可以在这里添加一个友好的提示
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error syncing user after login");
            // 捕获异常但不影响登录流程
        }
    }
}
