@page "/connections-new"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Contracts.Models
@using Verdure.McpPlatform.Web.Resources
@inject IXiaozhiMcpEndpointClientService ServerService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc

<PageTitle>@Loc["XiaozhiMcpEndpoints"] - @Loc["AppTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Hero Banner -->
    <MudCard Elevation="2" Style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
        <MudCardContent Class="pa-6">
            <div class="d-flex justify-space-between align-center flex-wrap" Style="gap: 1rem;">
                <div>
                    <MudText Typo="Typo.h4" Class="m3-mb-sm" Style="font-weight: 600; color: #FFFFFF;">
                        <MudIcon Icon="@Icons.Material.Outlined.Dns" Class="mr-2" Style="color: #FFFFFF;" /> @Loc["XiaozhiMcpEndpoints"]
                    </MudText>
                    <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); font-weight: 400;">
                        @Loc["ManageConnections"]
                    </MudText>
                </div>
                <MudButton Href="/connections/create" 
                          Variant="Variant.Filled" 
                          Style="background: #FFFFFF; color: #1976D2;"
                          StartIcon="@Icons.Material.Filled.Add"
                          Size="Size.Large"
                          Class="m3-button-lg">
                    @Loc["AddConnection"]
                </MudButton>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Search and View Controls -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="8">
            <MudTextField @bind-Value="_searchTerm" 
                         Placeholder="@Loc["SearchConnections"]"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Variant="Variant.Outlined"
                         Immediate="false"
                         DebounceInterval="500"
                         OnDebounceIntervalElapsed="OnSearchChanged"
                         FullWidth="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="4" Class="d-flex align-center justify-end">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @string.Format(Loc["ShowingItems"], _servers.Count, _totalCount)
            </MudText>
        </MudItem>
    </MudGrid>

    @if (_loading && _servers.Count == 0)
    {
        <!-- Initial Loading State -->
        <MudGrid Spacing="3">
            @for (int i = 0; i < 8; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Class="skeleton-card" Style="height: 280px;">
                        <MudCardContent>
                            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="30px" Class="mb-4" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" Class="mb-2" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" Class="mb-2" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (_servers.Count == 0 && !_loading)
    {
        <!-- Empty State -->
        <div class="m3-empty-state text-center" style="padding: 80px 20px;">
            <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                     Color="Color.Default" 
                     Style="font-size: 80px; opacity: 0.3;"
                     Class="mb-4" />
            <MudText Typo="Typo.h5" Class="mb-2" Style="font-weight: 500;">
                @Loc["NoConnectionsFound"]
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                @(_searchTerm?.Length > 0 
                    ? Loc["TryAdjustingSearch"]
                    : Loc["GetStartedCreateConnection"])
            </MudText>
            @if (string.IsNullOrEmpty(_searchTerm))
            {
                <MudButton Href="/connections/create" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Add"
                           Size="Size.Large">
                    @Loc["CreateConnection"]
                </MudButton>
            }
        </div>
    }
    else
    {
        <!-- Card Grid -->
        <MudGrid Spacing="3">
            @foreach (var server in _servers)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <ConnectionCard Connection="@server"
                                   OnEdit="@(() => EditServer(server.Id))"
                                   OnDelete="@(() => DeleteServer(server))"
                                   OnEnable="@(() => EnableServer(server))"
                                   OnDisable="@(() => DisableServer(server))"
                                   OnViewBindings="@(() => ViewBindings(server.Id))" />
                </MudItem>
            }
        </MudGrid>

        <!-- Load More Button / Infinite Scroll Trigger -->
        @if (_hasMoreData)
        {
            <div class="text-center mt-6" @ref="_loadMoreTrigger">
                @if (_loadingMore)
                {
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        @Loc["LoadingMore"]
                    </MudText>
                }
                else
                {
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              OnClick="LoadMoreAsync"
                              Size="Size.Large"
                              StartIcon="@Icons.Material.Filled.ExpandMore">
                        @Loc["LoadMore"]
                    </MudButton>
                }
            </div>
        }
        else if (_servers.Count > 0)
        {
            <div class="text-center mt-6">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @Loc["AllItemsLoaded"]
                </MudText>
            </div>
        }
    }
</MudContainer>

@code {
    private List<XiaozhiMcpEndpointDto> _servers = new();
    private bool _loading = true;
    private bool _loadingMore = false;
    private string _searchTerm = "";
    private int _currentPage = 1;
    private int _pageSize = 12;
    private int _totalCount = 0;
    private bool _hasMoreData = true;
    private ElementReference _loadMoreTrigger;

    protected override async Task OnInitializedAsync()
    {
        await LoadServersAsync(reset: true);
    }

    private async Task LoadServersAsync(bool reset = false)
    {
        try
        {
            if (reset)
            {
                _loading = true;
                _currentPage = 1;
                _servers.Clear();
            }
            else
            {
                _loadingMore = true;
            }

            var request = new PagedRequest
            {
                Page = _currentPage,
                PageSize = _pageSize,
                SearchTerm = _searchTerm,
                SortBy = "CreatedAt",
                SortOrder = "desc"
            };

            var result = await ServerService.GetServersPagedAsync(request);
            
            if (reset)
            {
                _servers = result.Items.ToList();
            }
            else
            {
                _servers.AddRange(result.Items);
            }

            _totalCount = result.TotalCount;
            _hasMoreData = result.HasNextPage;
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorLoadingConnections2"], ex.Message), Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["UnexpectedError"], ex.Message), Severity.Error);
        }
        finally
        {
            _loading = false;
            _loadingMore = false;
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_loadingMore || !_hasMoreData) return;
        
        _currentPage++;
        await LoadServersAsync(reset: false);
    }

    private async Task OnSearchChanged()
    {
        await LoadServersAsync(reset: true);
    }

    private void EditServer(string id)
    {
        Navigation.NavigateTo($"/connections/edit/{id}");
    }

    private void ViewBindings(string id)
    {
        Navigation.NavigateTo($"/connections/{id}/service-bindings");
    }

    private async Task EnableServer(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.EnableServerAsync(server.Id);
            
            // Reload server data from backend
            var updatedServer = await ServerService.GetServerAsync(server.Id);
            if (updatedServer != null)
            {
                var index = _servers.FindIndex(s => s.Id == server.Id);
                if (index >= 0)
                {
                    _servers[index] = updatedServer;
                }
            }
            
            Snackbar.Add(string.Format(Loc["ConnectionEnabled"], server.Name), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorEnablingServer"], ex.Message), Severity.Error);
        }
    }

    private async Task DisableServer(XiaozhiMcpEndpointDto server)
    {
        try
        {
            await ServerService.DisableServerAsync(server.Id);
            
            // Reload server data from backend
            var updatedServer = await ServerService.GetServerAsync(server.Id);
            if (updatedServer != null)
            {
                var index = _servers.FindIndex(s => s.Id == server.Id);
                if (index >= 0)
                {
                    _servers[index] = updatedServer;
                }
            }
            
            Snackbar.Add(string.Format(Loc["ConnectionDisabled"], server.Name), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorDisablingServer"], ex.Message), Severity.Error);
        }
    }

    private async Task DeleteServer(XiaozhiMcpEndpointDto server)
    {
        var parameters = new DialogParameters<DeleteConfirmationDialog>
        {
            { x => x.ContentText, string.Format(Loc["ConfirmDeleteConnection"], server.Name) },
            { x => x.ButtonText, Loc["Delete"] },
            { x => x.Color, Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>(Loc["ConfirmDelete"], parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await ServerService.DeleteServerAsync(server.Id);
                _servers.Remove(server);
                _totalCount--;
                Snackbar.Add(string.Format(Loc["ConnectionDeletedSuccess"], server.Name), Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(Loc["ErrorDeletingServer"], ex.Message), Severity.Error);
            }
        }
    }
}
