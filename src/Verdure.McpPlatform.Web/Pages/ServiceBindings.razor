@page "/service-bindings"
@page "/connections/{ConnectionId}/service-bindings"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@inject IMcpServiceBindingClientService BindingService
@inject IXiaozhiMcpEndpointClientService ServerService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Loc

<PageTitle>@Loc["McpServiceBindings"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner - 统一蓝色渐变 -->
    <MudItem xs="12">
        <MudCard Elevation="2" Style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); border-radius: 16px; overflow: hidden;" Class="m3-mb-xl">
            <MudCardContent Class="pa-6">
                <div class="d-flex justify-space-between align-center flex-wrap" Style="gap: 1rem;">
                    <div class="d-flex align-center" Style="gap: 0.5rem; flex: 1;">
                        @if (!string.IsNullOrEmpty(_connectionId))
                        {
                            <!-- 返回按钮 - 集成到标题左侧 -->
                            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                          Href="/connections"
                                          Style="color: #FFFFFF; background: rgba(255, 255, 255, 0.1);"
                                          Size="Size.Large"
                                          Title="@Loc["BackToServers"]" />
                        }
                        <div>
                            <MudText Typo="Typo.h4" Class="m3-mb-sm" Style="font-weight: 600; color: #FFFFFF;">
                                <MudIcon Icon="@Icons.Material.Filled.Link" Class="mr-2" Style="color: #FFFFFF;" /> 
                                @(!string.IsNullOrEmpty(_connectionId) ? string.Format(Loc["ServicesFor"], _serverName) : Loc["McpServiceBindings"])
                            </MudText>
                            <MudText Typo="Typo.body1" Style="color: rgba(255, 255, 255, 0.85); font-weight: 400;">
                                @if (_totalCount > 0)
                                {
                                    <span>@string.Format(Loc["TotalServiceBindings"], _totalCount)</span>
                                }
                                else
                                {
                                    <span>@(!string.IsNullOrEmpty(_connectionId) ? Loc["ManageServicesForConnection"] : Loc["ConfigureExternalServices"])</span>
                                }
                            </MudText>
                        </div>
                    </div>
                    <MudButton Href="@(!string.IsNullOrEmpty(_connectionId) ? $"/service-bindings/create?connectionId={_connectionId}" : "/service-bindings/create")" 
                              Variant="Variant.Filled" 
                              Style="background: #FFFFFF; color: #1976D2;"
                              StartIcon="@Icons.Material.Filled.Add"
                              Size="Size.Large"
                              Class="m3-button-lg">
                        @Loc["AddService"]
                    </MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Search and Filters -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="1">
            <MudGrid>
                <MudItem xs="12" sm="8">
                    <MudTextField @bind-Value="_searchTerm"
                                  Label="@Loc["Search"]"
                                  Placeholder="@Loc["SearchServices"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="500"
                                  OnDebounceIntervalElapsed="OnSearchChanged"
                                  Clearable="true"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect Value="_sortBy"
                               Label="@Loc["SortBy"]"
                               Variant="Variant.Outlined"
                               T="string"
                               ValueChanged="OnSortChanged">
                        <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                        <MudSelectItem Value="@("ServiceName")">@Loc["ServiceName"]</MudSelectItem>
                        <MudSelectItem Value="@("Status")">@Loc["Status"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <!-- Cards Container with Load More -->
    <MudItem xs="12">
        <div style="height: calc(100vh - 400px); overflow-y: auto; overflow-x: hidden;">
            <MudGrid Spacing="3" Class="px-4 py-2">
                @if (_initialLoading)
                {
                    for (var i = 0; i < PageSize; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 280px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                }
                else if (_bindings.Any())
                {
                    @foreach (var binding in _bindings)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <McpServiceBindingCard Binding="@binding"
                                                   OnEdit="@(() => EditBinding(binding.Id))"
                                                   OnDelete="@(() => DeleteBinding(binding))"
                                                   OnActivate="@(() => ActivateBinding(binding))"
                                                   OnDeactivate="@(() => DeactivateBinding(binding))" />
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
                            <MudIcon Icon="@Icons.Material.Outlined.CloudOff" 
                                     Style="font-size: 120px;" 
                                     Color="Color.Default" 
                                     Class="mb-4" />
                            <MudText Typo="Typo.h5" Class="mb-2">
                                @(string.IsNullOrWhiteSpace(_searchTerm) 
                                    ? Loc["NoServiceBindingsYet"]
                                    : Loc["NoServicesFound"])
                            </MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @(string.IsNullOrWhiteSpace(_searchTerm) 
                                    ? Loc["CreateFirstBinding"]
                                    : string.Format(Loc["NoMatchingBindings"], _searchTerm))
                            </MudText>
                            @if (string.IsNullOrWhiteSpace(_searchTerm))
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Href="@(!string.IsNullOrEmpty(_connectionId) ? $"/service-bindings/create?connectionId={_connectionId}" : "/service-bindings/create")">
                                    @Loc["CreateFirstBinding"]
                                </MudButton>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Clear"
                                           OnClick="ClearSearch">
                                    @Loc["ClearSearch"]
                                </MudButton>
                            }
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            @if (_loadingMore)
            {
                <MudGrid Spacing="3" Class="px-4 py-2">
                    @for (var i = 0; i < 3; i++)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard Style="height: 280px;" Elevation="2">
                                <MudCardContent>
                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Class="mb-2" />
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" Width="60%" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }

            @if (_hasMoreData && !_loadingMore && !_initialLoading)
            {
                <div class="d-flex justify-center py-4">
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               OnClick="LoadMoreAsync"
                               Style="text-transform: none;">
                        @Loc["LoadMore"]
                    </MudButton>
                </div>
            }
        </div>
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string? ConnectionId { get; set; }

    // UI state
    private string _searchTerm = "";
    private string _sortBy = "CreatedAt";
    private string _sortOrder = "desc";
    private int _totalCount = 0;
    private string _serverName = string.Empty;
    private string? _connectionId => ConnectionId;

    // Paging
    private const int PageSize = 12;
    private bool _initialLoading = true;
    private bool _loadingMore = false;
    private int _currentPage = 1;
    private bool _hasMoreData = true;
    private List<McpServiceBindingDto> _bindings = new();
    private List<McpServiceBindingDto> _filteredBindings = new();
    private List<McpServiceBindingDto> _bindingsCache = new();
    private string _bindingsCacheKey = string.Empty;
    private bool _bindingsCacheLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        // Load server name if viewing specific connection
        if (!string.IsNullOrEmpty(_connectionId))
        {
            try
            {
                var server = await ServerService.GetServerAsync(_connectionId);
                if (server != null)
                {
                    _serverName = server.Name;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading server: {ex.Message}");
            }
        }

        try
        {
            await LoadBindingsAsync(resetList: true, forceReload: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadBindingsAsync(bool resetList, bool forceReload = false)
    {
        try
        {
            if (resetList)
            {
                _currentPage = 1;
                _bindings.Clear();
                _hasMoreData = true;
            }

            var allBindings = await GetBindingsAsync(forceReload);
            _filteredBindings = ApplyFilters(allBindings);

            _totalCount = _filteredBindings.Count;

            var startIndex = (_currentPage - 1) * PageSize;
            var pageItems = _filteredBindings
                .Skip(startIndex)
                .Take(PageSize)
                .ToList();

            if (resetList)
            {
                _bindings = pageItems;
            }
            else
            {
                _bindings.AddRange(pageItems);
            }

            _hasMoreData = (_currentPage * PageSize) < _totalCount;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading bindings: {ex.Message}");
            Snackbar.Add(string.Format(Loc["ErrorLoadingServices"], ex.Message), Severity.Error);
            _bindings = new List<McpServiceBindingDto>();
            _totalCount = 0;
            _hasMoreData = false;
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_loadingMore || !_hasMoreData)
        {
            return;
        }

        _loadingMore = true;
        StateHasChanged();

        try
        {
            _currentPage++;
            await LoadBindingsAsync(resetList: false);
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private List<McpServiceBindingDto> ApplyFilters(IEnumerable<McpServiceBindingDto> bindings)
    {
        var filteredBindings = bindings.ToList();

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            filteredBindings = filteredBindings.Where(b =>
                b.ServiceName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (b.Description != null && b.Description.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }

        filteredBindings = _sortBy switch
        {
            "ServiceName" => _sortOrder == "asc" 
                ? filteredBindings.OrderBy(b => b.ServiceName).ToList()
                : filteredBindings.OrderByDescending(b => b.ServiceName).ToList(),
            "Status" => _sortOrder == "asc"
                ? filteredBindings.OrderBy(b => b.IsActive).ToList()
                : filteredBindings.OrderByDescending(b => b.IsActive).ToList(),
            _ => _sortOrder == "asc"
                ? filteredBindings.OrderBy(b => b.CreatedAt).ToList()
                : filteredBindings.OrderByDescending(b => b.CreatedAt).ToList()
        };

        return filteredBindings;
    }

    private async Task<List<McpServiceBindingDto>> GetBindingsAsync(bool forceReload)
    {
        var cacheKey = BuildBindingsCacheKey();
        if (!forceReload && _bindingsCacheLoaded && _bindingsCacheKey == cacheKey)
        {
            return _bindingsCache;
        }

        _bindingsCacheKey = cacheKey;
        _bindingsCacheLoaded = true;

        if (!string.IsNullOrEmpty(_connectionId))
        {
            var bindings = await BindingService.GetBindingsByServerAsync(_connectionId);
            _bindingsCache = bindings.ToList();
        }
        else
        {
            var servers = await ServerService.GetServersAsync();
            _bindingsCache = servers.SelectMany(s => s.ServiceBindings).ToList();
        }

        return _bindingsCache;
    }

    private string BuildBindingsCacheKey()
    {
        return string.IsNullOrEmpty(_connectionId) ? "all" : _connectionId;
    }

    private void InvalidateBindingsCache()
    {
        _bindingsCacheLoaded = false;
        _bindingsCacheKey = string.Empty;
        _bindingsCache = new List<McpServiceBindingDto>();
    }

    private async Task OnSearchChanged()
    {
        Console.WriteLine($"🔍 Search changed: '{_searchTerm}'");
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadBindingsAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSortChanged(string newSortBy)
    {
        Console.WriteLine($"📊 Sort changed: {_sortBy} → {newSortBy}");
        _sortBy = newSortBy;
        _initialLoading = true;
        StateHasChanged();

        try
        {
            await LoadBindingsAsync(resetList: true);
        }
        finally
        {
            _initialLoading = false;
            StateHasChanged();
        }
    }

    private void ClearSearch()
    {
        _searchTerm = "";
        _ = OnSearchChanged();
    }

    private void EditBinding(string id)
    {
        Navigation.NavigateTo($"/service-bindings/edit/{id}");
    }

    private async Task ActivateBinding(McpServiceBindingDto binding)
    {
        try
        {
            await BindingService.ActivateBindingAsync(binding.Id);
            Snackbar.Add(string.Format(Loc["ServiceActivated2"], binding.ServiceName), Severity.Success);
            InvalidateBindingsCache();
            _initialLoading = true;
            StateHasChanged();
            await LoadBindingsAsync(resetList: true, forceReload: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorActivatingBinding"], ex.Message), Severity.Error);
        }
    }

    private async Task DeactivateBinding(McpServiceBindingDto binding)
    {
        try
        {
            await BindingService.DeactivateBindingAsync(binding.Id);
            Snackbar.Add(string.Format(Loc["ServiceDeactivated2"], binding.ServiceName), Severity.Success);
            InvalidateBindingsCache();
            _initialLoading = true;
            StateHasChanged();
            await LoadBindingsAsync(resetList: true, forceReload: true);
            _initialLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc["ErrorDeactivatingBinding"], ex.Message), Severity.Error);
        }
    }

    private async Task DeleteBinding(McpServiceBindingDto binding)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            Loc["ConfirmDelete"],
            Loc["ConfirmDeleteService", binding.ServiceName],
            yesText: Loc["Delete"],
            cancelText: Loc["Cancel"]);

        if (confirm == true)
        {
            try
            {
                await BindingService.DeleteBindingAsync(binding.Id);
                _totalCount--;
                Snackbar.Add(string.Format(Loc["ServiceDeletedSuccess"], binding.ServiceName), Severity.Success);
                InvalidateBindingsCache();
                _initialLoading = true;
                StateHasChanged();
                await LoadBindingsAsync(resetList: true, forceReload: true);
                _initialLoading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(Loc["ErrorDeletingBinding"], ex.Message), Severity.Error);
            }
        }
    }
}
