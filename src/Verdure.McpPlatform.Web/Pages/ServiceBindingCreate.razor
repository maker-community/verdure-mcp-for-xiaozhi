@page "/service-bindings/create"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Contracts.Models
@using Verdure.McpPlatform.Contracts.Requests
@using Verdure.McpPlatform.Web.Services
@inject IMcpServiceBindingClientService BindingService
@inject IXiaozhiMcpEndpointClientService ServerService
@inject IMcpServiceConfigClientService McpServiceConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Loc

<PageTitle>@Loc["CreateServiceBinding"] - @Loc["AppTitle"]</PageTitle>

<MudGrid>
    <!-- M3 Hero Banner - 统一蓝色渐变 -->
    <MudItem xs="12">
        <MudCard Elevation="2" Class="m3-mb-xl m3-hero-card">
            <MudCardContent Class="pa-6">
                <div class="d-flex align-center" Style="gap: 1rem;">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                  Style="color: #FFFFFF;"
                                  OnClick="Cancel" 
                                  Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h4" Class="m3-hero-title" Style="font-weight: 600; margin: 0;">
                            @Loc["CreateServiceBinding"]
                        </MudText>
                        <MudText Typo="Typo.body1" Class="m3-hero-subtitle">
                            @Loc["ConfigureNewServiceBinding"]
                        </MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Selected Service Info (when coming from public service) -->
    @if (IsFromPublicService && !string.IsNullOrEmpty(_selectedServiceName))
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Success" 
                      Icon="@Icons.Material.Filled.CheckCircle"
                      Elevation="1"
                      Variant="Variant.Filled">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                            @Loc["SelectedService"]: @_selectedServiceName
                        </MudText>
                        <MudText Typo="Typo.caption">
                            @Loc["NowSelectConnectionAndTools"]
                        </MudText>
                    </div>
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Variant="Variant.Text"
                             Style="background: rgba(255,255,255,0.2); color: white;"
                             Icon="@Icons.Material.Filled.Public">
                        @Loc["Public"]
                    </MudChip>
                </div>
            </MudAlert>
        </MudItem>
    }

    <!-- Wizard Progress -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader Style="background: linear-gradient(135deg, rgba(var(--m3-primary-rgb), 0.08) 0%, rgba(var(--m3-primary-rgb), 0.03) 100%);">
                <CardHeaderContent>
                    <div class="d-flex align-center justify-space-between" style="gap: 16px;">
                        @if (!IsFromPublicService)
                        {
                            <!-- Normal 3-step flow -->
                            <!-- Step 1 -->
                            <div class="d-flex align-center" style="gap: 8px; flex: 1;">
                                <MudAvatar Size="Size.Medium" Color="@(_currentStep >= 0 ? Color.Primary : Color.Default)">
                                    @if (_currentStep > 0)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" />
                                    }
                                    else
                                    {
                                        <span>1</span>
                                    }
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2" Style="@(_currentStep == 0 ? "font-weight: 600;" : "")">@Loc["SelectConnection"]</MudText>
                                    @if (_currentStep == 0)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">@Loc["Active"]</MudText>
                                    }
                                </div>
                            </div>
                            
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Default" Style="opacity: 0.3;" />
                            
                            <!-- Step 2 -->
                            <div class="d-flex align-center" style="gap: 8px; flex: 1;">
                                <MudAvatar Size="Size.Medium" Color="@(_currentStep >= 1 ? Color.Primary : Color.Default)">
                                    @if (_currentStep > 1)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" />
                                    }
                                    else
                                    {
                                        <span>2</span>
                                    }
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2" Style="@(_currentStep == 1 ? "font-weight: 600;" : "")">@Loc["SelectMcpService"]</MudText>
                                    @if (_currentStep == 1)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">@Loc["Active"]</MudText>
                                    }
                                </div>
                            </div>
                            
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Default" Style="opacity: 0.3;" />
                            
                            <!-- Step 3 -->
                            <div class="d-flex align-center" style="gap: 8px; flex: 1;">
                                <MudAvatar Size="Size.Medium" Color="@(_currentStep >= 2 ? Color.Primary : Color.Default)">
                                    <span>3</span>
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2" Style="@(_currentStep == 2 ? "font-weight: 600;" : "")">@Loc["ConfigureTools"]</MudText>
                                    @if (_currentStep == 2)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">@Loc["Active"]</MudText>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Simplified 2-step flow for public service -->
                            <!-- Step 1: Select Connection -->
                            <div class="d-flex align-center" style="gap: 8px; flex: 1;">
                                <MudAvatar Size="Size.Medium" Color="@(_currentStep >= 0 ? Color.Primary : Color.Default)">
                                    @if (_currentStep > 0)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" />
                                    }
                                    else
                                    {
                                        <span>1</span>
                                    }
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2" Style="@(_currentStep == 0 ? "font-weight: 600;" : "")">@Loc["SelectConnection"]</MudText>
                                    @if (_currentStep == 0)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">@Loc["Active"]</MudText>
                                    }
                                </div>
                            </div>
                            
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Default" Style="opacity: 0.3;" />
                            
                            <!-- Step 2: Configure Tools -->
                            <div class="d-flex align-center" style="gap: 8px; flex: 1;">
                                <MudAvatar Size="Size.Medium" Color="@(_currentStep >= 1 ? Color.Primary : Color.Default)">
                                    <span>2</span>
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2" Style="@(_currentStep == 1 ? "font-weight: 600;" : "")">@Loc["ConfigureTools"]</MudText>
                                    @if (_currentStep == 1)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">@Loc["Active"]</MudText>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </CardHeaderContent>
            </MudCardHeader>

            <MudCardContent Class="pa-6" Style="min-height: 500px;">
                @* Step 0: Select Connection (always first step when from public service) *@
                @* Step 1: Select Service (skipped when from public service) *@
                @if (_currentStep == 0 && !IsFromPublicService)
                {
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-4">@Loc["ChooseXiaozhiConnection"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                            @Loc["SelectConnectionHelp"]
                        </MudText>

                        <!-- Search and Sort -->
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="8">
                                <MudTextField @bind-Value="_connectionSearchTerm"
                                              Label="@Loc["Search"]"
                                              Placeholder="@Loc["SearchConnections"]"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Immediate="true"
                                              DebounceInterval="500"
                                              OnDebounceIntervalElapsed="OnConnectionSearchChanged"
                                              Clearable="true"
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudSelect Value="_connectionSortBy"
                                           Label="@Loc["SortBy"]"
                                           Variant="Variant.Outlined"
                                           T="string"
                                           ValueChanged="OnConnectionSortChanged">
                                    <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                                    <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                                    <MudSelectItem Value="@("Status")">@Loc["Status"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <!-- Connection Cards with Load More -->
                        <div style="height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid var(--m3-outline); border-radius: 8px;">
                            <MudGrid Spacing="3" Class="pa-3">
                                @if (_connectionInitialLoading)
                                {
                                    for (var i = 0; i < ConnectionPageSize; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                }
                                else if (_connections.Any())
                                {
                                    @foreach (var connection in _connections)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <ConnectionSelectorCard Connection="@connection"
                                                                   IsSelected="@(_selectedConnectionId == connection.Id)"
                                                                   OnSelect="@(() => SelectConnection(connection.Id, connection.Name))" />
                                        </MudItem>
                                    }
                                }
                                else
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">
                                            @Loc["NoConnectionsFound"]
                                        </MudText>
                                    </MudItem>
                                }
                            </MudGrid>

                            @if (_connectionLoadingMore)
                            {
                                <MudGrid Spacing="3" Class="pa-3">
                                    @for (var i = 0; i < 3; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }

                            @if (_connectionHasMoreData && !_connectionLoadingMore && !_connectionInitialLoading)
                            {
                                <div class="load-more-container d-flex justify-center">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               Class="m3-button load-more-button"
                                               OnClick="LoadMoreConnectionsAsync">
                                        @Loc["LoadMore"]
                                    </MudButton>
                                </div>
                            }
                        </div>
                    </div>
                }

                @* Step 1: Select Connection (when from public service) *@
                @if (_currentStep == 0 && IsFromPublicService)
                {
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-4">@Loc["ChooseXiaozhiConnection"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                            @Loc["SelectConnectionHelp"]
                        </MudText>

                        <!-- Search and Sort -->
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="8">
                                <MudTextField @bind-Value="_connectionSearchTerm"
                                              Label="@Loc["Search"]"
                                              Placeholder="@Loc["SearchConnections"]"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Immediate="true"
                                              DebounceInterval="500"
                                              OnDebounceIntervalElapsed="OnConnectionSearchChanged"
                                              Clearable="true"
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudSelect Value="_connectionSortBy"
                                           Label="@Loc["SortBy"]"
                                           Variant="Variant.Outlined"
                                           T="string"
                                           ValueChanged="OnConnectionSortChanged">
                                    <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                                    <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                                    <MudSelectItem Value="@("Status")">@Loc["Status"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <!-- Connection Cards with Load More -->
                        <div style="height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid var(--m3-outline); border-radius: 8px;">
                            <MudGrid Spacing="3" Class="pa-3">
                                @if (_connectionInitialLoading)
                                {
                                    for (var i = 0; i < ConnectionPageSize; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                }
                                else if (_connections.Any())
                                {
                                    @foreach (var connection in _connections)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <ConnectionSelectorCard Connection="@connection"
                                                                   IsSelected="@(_selectedConnectionId == connection.Id)"
                                                                   OnSelect="@(() => SelectConnection(connection.Id, connection.Name))" />
                                        </MudItem>
                                    }
                                }
                                else
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">
                                            @Loc["NoConnectionsFound"]
                                        </MudText>
                                    </MudItem>
                                }
                            </MudGrid>

                            @if (_connectionLoadingMore)
                            {
                                <MudGrid Spacing="3" Class="pa-3">
                                    @for (var i = 0; i < 3; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }

                            @if (_connectionHasMoreData && !_connectionLoadingMore && !_connectionInitialLoading)
                            {
                                <div class="load-more-container d-flex justify-center">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               Class="m3-button load-more-button"
                                               OnClick="LoadMoreConnectionsAsync">
                                        @Loc["LoadMore"]
                                    </MudButton>
                                </div>
                            }
                        </div>
                    </div>
                }

                @* Step 2: Select Service (normal flow) *@
                @if (_currentStep == 1 && !IsFromPublicService)
                {
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-4">@Loc["ChooseMcpService"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                            @Loc["SelectMcpServiceHelp"]
                        </MudText>

                        <!-- Tabs for My/Public Services -->
                        <MudTabs Elevation="0" Rounded="true" 
                                 ActivePanelIndex="@_serviceTabIndex"
                                 ActivePanelIndexChanged="OnServiceTabChanged"
                                 PanelClass="pa-0" Class="mb-4">
                            <MudTabPanel Text="@Loc["MyServices"]" Icon="@Icons.Material.Filled.Person" />
                            <MudTabPanel Text="@Loc["PublicServices"]" Icon="@Icons.Material.Filled.Public" />
                        </MudTabs>

                        <!-- Search and Sort -->
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="8">
                                <MudTextField @bind-Value="_serviceSearchTerm"
                                              Label="@Loc["Search"]"
                                              Placeholder="@Loc["SearchMcpServices"]"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Immediate="true"
                                              DebounceInterval="500"
                                              OnDebounceIntervalElapsed="OnServiceSearchChanged"
                                              Clearable="true"
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudSelect Value="_serviceSortBy"
                                           Label="@Loc["SortBy"]"
                                           Variant="Variant.Outlined"
                                           T="string"
                                           ValueChanged="OnServiceSortChanged">
                                    <MudSelectItem Value="@("Name")">@Loc["Name"]</MudSelectItem>
                                    <MudSelectItem Value="@("CreatedAt")">@Loc["CreatedDate"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <!-- Service Cards with Load More -->
                        <div style="height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid var(--m3-outline); border-radius: 8px;">
                            <MudGrid Spacing="3" Class="pa-3">
                                @if (_serviceInitialLoading)
                                {
                                    for (var i = 0; i < ServicePageSize; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                }
                                else if (_services.Any())
                                {
                                    @foreach (var service in _services)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <McpServiceSelectorCard Service="@service"
                                                                   IsSelected="@(_selectedServiceId == service.Id)"
                                                                   OnSelect="@(() => SelectService(service.Id, service.Name))" />
                                        </MudItem>
                                    }
                                }
                                else
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">
                                            @Loc["NoServicesFound"]
                                        </MudText>
                                    </MudItem>
                                }
                            </MudGrid>

                            @if (_serviceLoadingMore)
                            {
                                <MudGrid Spacing="3" Class="pa-3">
                                    @for (var i = 0; i < 3; i++)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudCard Style="height: 200px;">
                                                <MudCardContent>
                                                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="30px" Class="mb-2" />
                                                    <MudSkeleton SkeletonType="SkeletonType.Text" Height="20px" />
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }

                            @if (_serviceHasMoreData && !_serviceLoadingMore && !_serviceInitialLoading)
                            {
                                <div class="load-more-container d-flex justify-center">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               Class="m3-button load-more-button"
                                               OnClick="LoadMoreServicesAsync">
                                        @Loc["LoadMore"]
                                    </MudButton>
                                </div>
                            }
                        </div>
                    </div>
                }

                @* Step 2: Configure Tools (when from public service) *@
                @* Step 3: Configure Tools (normal flow) *@
                @if ((_currentStep == 1 && IsFromPublicService) || (_currentStep == 2 && !IsFromPublicService))
                {
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-4">@Loc["SelectTools"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                            @Loc["SelectToolsHelp"]
                        </MudText>

                        @if (_loadingTools)
                        {
                            <div class="d-flex flex-column align-center justify-center pa-8">
                                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">@Loc["LoadingTools"]</MudText>
                            </div>
                        }
                        else if (_availableTools.Any())
                        {
                            <!-- Tool Selection with Search -->
                            <MudTextField @bind-Value="_toolSearchTerm"
                                          Label="@Loc["SearchTools"]"
                                          Placeholder="@Loc["FilterToolsByName"]"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Clearable="true"
                                          Variant="Variant.Outlined"
                                          Class="mb-4" />

                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--m3-outline); border-radius: 8px; padding: 16px;">
                                @foreach (var tool in GetFilteredTools())
                                {
                                    var toolName = tool.Name;
                                    <MudCheckBox T="bool" 
                                                Value="@_selectedTools.Contains(toolName)"
                                                ValueChanged="@((bool isChecked) => ToggleTool(toolName, isChecked))"
                                                Color="Color.Primary"
                                                Dense="true"
                                                Class="mb-2">
                                        <div>
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@tool.Name</MudText>
                                            @if (!string.IsNullOrEmpty(tool.Description))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@tool.Description</MudText>
                                            }
                                        </div>
                                    </MudCheckBox>
                                }
                            </div>

                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3">
                                @string.Format(Loc["SelectedTools"], _selectedTools.Count)
                            </MudText>

                            <!-- Description (Optional) -->
                            <MudTextField @bind-Value="_description" 
                                         Label="@Loc["Description"]" 
                                         Lines="3"
                                         Variant="Variant.Outlined"
                                         HelperText="@Loc["ServiceBindingDescriptionOptional"]"
                                         Class="mt-4" />

                            <!-- Summary Card -->
                            <MudCard Outlined="true" Class="mt-4">
                                <MudCardHeader Style="background: linear-gradient(135deg, rgba(25, 118, 210, 0.08) 0%, rgba(25, 118, 210, 0.03) 100%);">
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@Loc["BindingSummary"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Loc["XiaozhiMcpEndpoint"]</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@_selectedConnectionName</MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Loc["McpService"]</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@_selectedServiceName</MudText>
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Loc["SelectedToolsCount"]</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@_selectedTools.Count / @_availableTools.Count</MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">@Loc["NoToolsAvailable"]</MudAlert>
                        }
                    </div>
                }
            </MudCardContent>

            <!-- Action Buttons -->
            <MudCardActions Class="pa-4">
                <MudButton Variant="Variant.Text" 
                          Color="Color.Default" 
                          OnClick="Cancel">
                    @Loc["Cancel"]
                </MudButton>
                <MudSpacer />
                
                @if (_currentStep > 0)
                {
                    <MudButton Variant="Variant.Text" 
                              Color="Color.Primary" 
                              OnClick="PreviousStep">
                        @Loc["Previous"]
                    </MudButton>
                }
                
                @if (!IsAtFinalStep())
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="NextStep"
                              Disabled="@(!CanProceedToNextStep())">
                        @Loc["Next"]
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="SaveAsync" 
                              Disabled="@(_saving || !CanComplete())"
                              StartIcon="@Icons.Material.Filled.Save">
                        @if (_saving)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                            <MudText>@Loc["Saving"]</MudText>
                        }
                        else
                        {
                            <MudText>@Loc["Create"]</MudText>
                        }
                    </MudButton>
                }
            </MudCardActions>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery]
    public string? ConnectionId { get; set; }

    [SupplyParameterFromQuery]
    public string? PublicServiceId { get; set; }

    // Flag to track if this is from public service "Use This Service" flow
    private bool IsFromPublicService => !string.IsNullOrEmpty(PublicServiceId);

    // Wizard State
    private int _currentStep = 0;
    private bool _saving;

    // Step 1: Connection Selection
    private string _connectionSearchTerm = "";
    private string _connectionSortBy = "Name";
    private string? _selectedConnectionId;
    private string _selectedConnectionName = "";
    private const int ConnectionPageSize = 12;
    private bool _connectionInitialLoading = true;
    private bool _connectionLoadingMore = false;
    private int _connectionCurrentPage = 1;
    private bool _connectionHasMoreData = true;
    private List<XiaozhiMcpEndpointDto> _connections = new();

    // Step 2: Service Selection
    private int _serviceTabIndex = 0;
    private string _serviceSearchTerm = "";
    private string _serviceSortBy = "Name";
    private string? _selectedServiceId;
    private string _selectedServiceName = "";
    private const int ServicePageSize = 12;
    private bool _serviceInitialLoading = true;
    private bool _serviceLoadingMore = false;
    private int _serviceCurrentPage = 1;
    private bool _serviceHasMoreData = true;
    private List<McpServiceConfigDto> _services = new();

    // Step 3: Tool Configuration
    private List<McpToolDto> _availableTools = new();
    private HashSet<string> _selectedTools = new();
    private bool _loadingTools = false;
    private string _toolSearchTerm = "";
    private string _description = "";

    protected override async Task OnInitializedAsync()
    {
        // Pre-select public service if provided (from "Use This Service" button)
        if (!string.IsNullOrEmpty(PublicServiceId))
        {
            _selectedServiceId = PublicServiceId;
            _serviceTabIndex = 1; // Switch to public services tab
            await LoadServiceName();
            // Start from step 0 (Select Connection) in simplified flow
            _currentStep = 0;
        }
        // Pre-select connection if provided in query
        else if (!string.IsNullOrEmpty(ConnectionId))
        {
            _selectedConnectionId = ConnectionId;
            await LoadConnectionName();
            // Normal flow starts from step 0
            _currentStep = 0;
        }

        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _connectionInitialLoading = false;
            StateHasChanged();
        }

        if (!IsFromPublicService)
        {
            try
            {
                await LoadServicesAsync(resetList: true);
            }
            finally
            {
                _serviceInitialLoading = false;
                StateHasChanged();
            }
        }
    }

    #region Step 1: Connection Selection

    private async Task LoadConnectionsAsync(bool resetList)
    {
        try
        {
            if (resetList)
            {
                _connectionCurrentPage = 1;
                _connections.Clear();
                _connectionHasMoreData = true;
            }

            var pagedRequest = new PagedRequest
            {
                Page = _connectionCurrentPage,
                PageSize = ConnectionPageSize,
                SearchTerm = _connectionSearchTerm,
                SortBy = _connectionSortBy,
                SortOrder = "asc"
            };

            var result = await ServerService.GetServersPagedAsync(pagedRequest);
            if (resetList)
            {
                _connections = result.Items.ToList();
            }
            else
            {
                _connections.AddRange(result.Items);
            }

            _connectionHasMoreData = _connectionCurrentPage < result.TotalPages;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
            _connections = new List<XiaozhiMcpEndpointDto>();
            _connectionHasMoreData = false;
        }
    }

    private async Task OnConnectionSearchChanged()
    {
        _connectionInitialLoading = true;
        StateHasChanged();

        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _connectionInitialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnConnectionSortChanged(string newSort)
    {
        _connectionSortBy = newSort;
        _connectionInitialLoading = true;
        StateHasChanged();

        try
        {
            await LoadConnectionsAsync(resetList: true);
        }
        finally
        {
            _connectionInitialLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreConnectionsAsync()
    {
        if (_connectionLoadingMore || !_connectionHasMoreData)
        {
            return;
        }

        _connectionLoadingMore = true;
        StateHasChanged();

        try
        {
            _connectionCurrentPage++;
            await LoadConnectionsAsync(resetList: false);
        }
        finally
        {
            _connectionLoadingMore = false;
            StateHasChanged();
        }
    }

    private void SelectConnection(string connectionId, string connectionName)
    {
        _selectedConnectionId = connectionId;
        _selectedConnectionName = connectionName;
        StateHasChanged();
    }

    private async Task LoadConnectionName()
    {
        if (!string.IsNullOrEmpty(_selectedConnectionId))
        {
            try
            {
                var connection = await ServerService.GetServerAsync(_selectedConnectionId);
                if (connection != null)
                {
                    _selectedConnectionName = connection.Name;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading connection: {ex.Message}");
            }
        }
    }

    #endregion

    #region Step 2: Service Selection

    private async Task LoadServicesAsync(bool resetList)
    {
        try
        {
            if (resetList)
            {
                _serviceCurrentPage = 1;
                _services.Clear();
                _serviceHasMoreData = true;
            }

            var pagedRequest = new PagedRequest
            {
                Page = _serviceCurrentPage,
                PageSize = ServicePageSize,
                SearchTerm = _serviceSearchTerm,
                SortBy = _serviceSortBy,
                SortOrder = "asc"
            };

            var result = _serviceTabIndex == 0
                ? await McpServiceConfigService.GetServicesPagedAsync(pagedRequest)
                : await McpServiceConfigService.GetPublicServicesPagedAsync(pagedRequest);

            if (resetList)
            {
                _services = result.Items.ToList();
            }
            else
            {
                _services.AddRange(result.Items);
            }

            _serviceHasMoreData = _serviceCurrentPage < result.TotalPages;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
            _services = new List<McpServiceConfigDto>();
            _serviceHasMoreData = false;
        }
    }

    private async Task OnServiceSearchChanged()
    {
        _serviceInitialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _serviceInitialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnServiceSortChanged(string newSort)
    {
        _serviceSortBy = newSort;
        _serviceInitialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _serviceInitialLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnServiceTabChanged(int index)
    {
        _serviceTabIndex = index;
        _serviceInitialLoading = true;
        StateHasChanged();

        try
        {
            await LoadServicesAsync(resetList: true);
        }
        finally
        {
            _serviceInitialLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreServicesAsync()
    {
        if (_serviceLoadingMore || !_serviceHasMoreData)
        {
            return;
        }

        _serviceLoadingMore = true;
        StateHasChanged();

        try
        {
            _serviceCurrentPage++;
            await LoadServicesAsync(resetList: false);
        }
        finally
        {
            _serviceLoadingMore = false;
            StateHasChanged();
        }
    }

    private async Task SelectService(string serviceId, string serviceName)
    {
        _selectedServiceId = serviceId;
        _selectedServiceName = serviceName;
        StateHasChanged();
    }

    private async Task LoadServiceName()
    {
        if (!string.IsNullOrEmpty(_selectedServiceId))
        {
            try
            {
                var service = await McpServiceConfigService.GetServiceAsync(_selectedServiceId);
                if (service != null)
                {
                    _selectedServiceName = service.Name;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading service: {ex.Message}");
            }
        }
    }

    #endregion

    #region Step 3: Tool Configuration

    private async Task LoadToolsForService()
    {
        if (string.IsNullOrEmpty(_selectedServiceId))
        {
            _availableTools.Clear();
            _selectedTools.Clear();
            return;
        }

        try
        {
            _loadingTools = true;
            var tools = await McpServiceConfigService.GetToolsAsync(_selectedServiceId);
            _availableTools = tools.ToList();
            _selectedTools.Clear(); // Reset selection when changing service
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["ErrorLoadingTools"]}: {ex.Message}", Severity.Error);
            _availableTools.Clear();
        }
        finally
        {
            _loadingTools = false;
        }
    }

    private void ToggleTool(string toolName, bool isChecked)
    {
        if (isChecked)
        {
            _selectedTools.Add(toolName);
        }
        else
        {
            _selectedTools.Remove(toolName);
        }
        StateHasChanged();
    }

    private IEnumerable<McpToolDto> GetFilteredTools()
    {
        if (string.IsNullOrWhiteSpace(_toolSearchTerm))
        {
            return _availableTools;
        }

        return _availableTools.Where(t =>
            t.Name.Contains(_toolSearchTerm, StringComparison.OrdinalIgnoreCase) ||
            (t.Description?.Contains(_toolSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        );
    }

    #endregion

    #region Navigation and Validation

    private bool IsAtFinalStep()
    {
        // In public service flow: final step is 1 (Configure Tools)
        // In normal flow: final step is 2 (Configure Tools)
        return IsFromPublicService ? _currentStep == 1 : _currentStep == 2;
    }

    private bool CanProceedToNextStep()
    {
        if (IsFromPublicService)
        {
            // Simplified flow: Service → Connection → Tools
            return _currentStep switch
            {
                0 => !string.IsNullOrEmpty(_selectedConnectionId), // Step 1: Connection selected
                _ => false
            };
        }
        else
        {
            // Normal flow: Connection → Service → Tools
            return _currentStep switch
            {
                0 => !string.IsNullOrEmpty(_selectedConnectionId), // Step 1: Connection selected
                1 => !string.IsNullOrEmpty(_selectedServiceId),    // Step 2: Service selected
                _ => false
            };
        }
    }

    private bool CanComplete()
    {
        return !string.IsNullOrEmpty(_selectedConnectionId) 
            && !string.IsNullOrEmpty(_selectedServiceId);
        // Note: Tool selection is optional
    }

    private void PreviousStep()
    {
        if (_currentStep > 0)
        {
            _currentStep--;
            StateHasChanged();
        }
    }

    private async Task NextStep()
    {
        if (!CanProceedToNextStep())
            return;

        _currentStep++;
        
        // Load tools when entering the final step (Configure Tools)
        if (IsAtFinalStep())
        {
            await LoadToolsForService();
        }
        
        StateHasChanged();
    }

    private async Task SaveAsync()
    {
        if (!CanComplete())
            return;

        try
        {
            _saving = true;

            var request = new CreateMcpServiceBindingRequest
            {
                ServerId = _selectedConnectionId!,
                McpServiceConfigId = _selectedServiceId!,
                Description = string.IsNullOrWhiteSpace(_description) ? null : _description,
                SelectedToolNames = _selectedTools.ToList()
            };

            await BindingService.CreateBindingAsync(request);
            Snackbar.Add(Loc["ServiceBindingCreatedSuccess"], Severity.Success);
            Navigation.NavigateTo("/service-bindings");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/service-bindings");
    }

    #endregion

    
}
