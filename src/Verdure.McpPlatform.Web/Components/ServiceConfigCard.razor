@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Web.Services
@inject IStringLocalizer<SharedResources> Loc
@inject IDateTimeFormatter DateTimeFormatter

<MudCard Elevation="2" 
         Class="service-config-card m3-card-content" 
         Style="height: 100%; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
    
    <!-- Header with Logo and Status -->
    <MudCardHeader Class="m3-card-header-tonal" Style="padding: 16px;">
        <CardHeaderContent>
            <div class="d-flex align-center justify-space-between" style="width: 100%;">
                <div class="d-flex align-center" style="gap: 12px; flex: 1; min-width: 0;">
                    <!-- Logo Placeholder (can be replaced with actual logo later) -->
                    <div style="position: relative;">
                        <MudAvatar Size="Size.Medium" 
                                   Color="Color.Primary"
                                   Style="background: linear-gradient(135deg, var(--m3-primary) 0%, var(--m3-primary-dark) 100%); color: white;">
                            @if (!string.IsNullOrEmpty(Service.LogoUrl))
                            {
                                <MudImage Src="@Service.LogoUrl" Alt="@Service.Name" Style="width: 100%; height: 100%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                            }
                        </MudAvatar>
                        @if (Service.IsPublic)
                        {
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: var(--m3-success); border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(var(--m3-success-rgb), 0.2);"></div>
                        }
                    </div>
                    
                    <!-- Service Name -->
                    <MudText Typo="Typo.h6" 
                             Style="font-weight: 600; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--m3-on-surface);">
                        @Service.Name
                    </MudText>
                </div>
                
                <!-- Actions Menu (only for owned services) -->
                @if (!IsPublicView)
                {
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                             Size="Size.Small" 
                             AnchorOrigin="Origin.BottomRight"
                             Style="flex-shrink: 0;">
                        <MudMenuItem Icon="@Icons.Material.Outlined.Visibility" OnClick="@OnViewDetails">
                            @Loc["ViewDetails"]
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Outlined.Sync" 
                                     OnClick="@OnSyncTools"
                                     Disabled="@IsSyncing">
                            @Loc["SyncTools"]
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Outlined.Edit" OnClick="@OnEdit">
                            @Loc["Edit"]
                        </MudMenuItem>
                        
                        <!-- Admin Only: Public/Private Toggle -->
                        @if (ShowAdminActions)
                        {
                            <MudDivider />
                            @if (Service.IsPublic)
                            {
                                <MudMenuItem Icon="@Icons.Material.Outlined.Lock" 
                                             IconColor="Color.Warning"
                                             OnClick="@OnSetPrivate">
                                    @Loc["SetPrivate"]
                                </MudMenuItem>
                            }
                            else
                            {
                                <MudMenuItem Icon="@Icons.Material.Outlined.Public" 
                                             IconColor="Color.Success"
                                             OnClick="@OnSetPublic">
                                    @Loc["SetPublic"]
                                </MudMenuItem>
                            }
                        }
                        
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Outlined.Delete" 
                                     IconColor="Color.Error" 
                                     OnClick="@OnDelete">
                            @Loc["Delete"]
                        </MudMenuItem>
                    </MudMenu>
                }
                else
                {
                    <MudIconButton Icon="@Icons.Material.Outlined.Visibility"
                                   Size="Size.Small"
                                   OnClick="@OnViewDetails"
                                   Style="flex-shrink: 0;" />
                }
            </div>
        </CardHeaderContent>
    </MudCardHeader>
    
    <!-- Card Content -->
    <MudCardContent Style="flex-grow: 1; padding: 20px;">
        <!-- Description -->
        @if (!string.IsNullOrWhiteSpace(Service.Description))
        {
            <MudText Typo="Typo.body2" 
                     Color="Color.Secondary" 
                     Class="mb-4" 
                     Style="line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 44px;">
                @Service.Description
            </MudText>
        }
        else
        {
            <MudText Typo="Typo.body2" 
                     Color="Color.Secondary" 
                     Class="mb-4" 
                     Style="font-style: italic; opacity: 0.6; min-height: 44px;">
                @Loc["NoDescription"]
            </MudText>
        }
        
        <!-- Status Pills -->
        <div class="d-flex flex-wrap align-center mb-3" style="gap: 8px;">
            <!-- Protocol -->
            <MudChip T="string" 
                     Size="Size.Small" 
                     Variant="Variant.Outlined"
                     Style="border-color: var(--m3-primary); color: var(--m3-primary); font-weight: 500; border-radius: 16px;"
                     Icon="@Icons.Material.Filled.Code">
                @(Service.Protocol ?? "stdio")
            </MudChip>
            
            <!-- Visibility -->
            @if (Service.IsPublic)
            {
                <MudChip T="string" 
                         Size="Size.Small" 
                         Variant="Variant.Filled"
                         Style="background: var(--m3-success-container); color: var(--m3-success); font-weight: 500; border-radius: 16px;"
                         Icon="@Icons.Material.Filled.Public">
                    @Loc["Public"]
                </MudChip>
            }
            else
            {
                <MudChip T="string" 
                         Size="Size.Small" 
                         Variant="Variant.Outlined"
                         Style="border-color: var(--m3-outline); color: var(--m3-on-surface-variant); font-weight: 500; border-radius: 16px;"
                         Icon="@Icons.Material.Filled.Lock">
                    @Loc["Private"]
                </MudChip>
            }
            
            <!-- Tools Count -->
            <MudChip T="string" 
                     Size="Size.Small" 
                     Variant="Variant.Outlined"
                     Style="border-color: var(--m3-primary); color: var(--m3-primary); font-weight: 500; border-radius: 16px;"
                     Icon="@Icons.Material.Filled.Build">
                @string.Format(Loc["ToolsCount"], Service.Tools?.Count ?? 0)
            </MudChip>
        </div>
        
        <!-- Last Synced (only for owned services) -->
        @if (!IsPublicView)
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3">
                <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Small" Style="vertical-align: middle; margin-right: 4px;" />
                @if (Service.LastSyncedAt.HasValue)
                {
                    <span title="@DateTimeFormatter.FormatDateTime(Service.LastSyncedAt)">
                        @($"{Loc["LastSynced"]}: {DateTimeFormatter.FormatFriendlyDateTime(Service.LastSyncedAt)}")
                    </span>
                }
                else
                {
                    @Loc["NeverSynced"]
                }
            </MudText>
        }
        else if (Service.Creator != null)
        {
            <!-- Creator Information for Public Services -->
            <div class="d-flex align-center" style="gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 0, 0, 0.08);">
                <!-- Creator Avatar -->
                <MudAvatar Size="Size.Small" 
                           Color="Color.Primary"
                           Style="width: 24px; height: 24px; font-size: 11px; background: linear-gradient(135deg, var(--m3-primary) 0%, var(--m3-primary-dark) 100%);">
                    @if (!string.IsNullOrEmpty(Service.Creator.AvatarUrl))
                    {
                        <MudImage Src="@Service.Creator.AvatarUrl" Alt="@GetCreatorName()" Style="width: 100%; height: 100%; object-fit: cover;" />
                    }
                    else
                    {
                        @GetInitials(GetCreatorName())
                    }
                </MudAvatar>
                
                <!-- Creator Name and Date -->
                <div style="flex: 1; min-width: 0;">
                    <MudText Typo="Typo.caption" 
                             Style="color: var(--m3-on-surface-variant); font-weight: 500; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        @GetCreatorName()
                    </MudText>
                    <MudText Typo="Typo.caption" 
                             Style="color: var(--m3-on-surface-variant); font-size: 11px; line-height: 1.2;"
                             title="@DateTimeFormatter.FormatDateTime(Service.CreatedAt)">
                        @DateTimeFormatter.FormatFriendlyDate(Service.CreatedAt)
                    </MudText>
                </div>
            </div>
        }
        else
        {
            <!-- Metadata Footer for Public Services (without creator info) -->
            <div class="d-flex align-center" style="gap: 4px; margin-top: auto;">
                <MudIcon Icon="@Icons.Material.Outlined.Schedule" 
                         Size="Size.Small" 
                         Style="color: var(--m3-on-surface-variant); font-size: 16px;" />
                <MudText Typo="Typo.caption" 
                         Style="color: var(--m3-on-surface-variant); font-weight: 400;"
                         title="@DateTimeFormatter.FormatDateTime(Service.CreatedAt)">
                    @DateTimeFormatter.FormatFriendlyDate(Service.CreatedAt)
                </MudText>
            </div>
        }
    </MudCardContent>
    
    <!-- Card Actions -->
    <MudDivider Style="margin: 0;" />
    <MudCardActions Style="padding: 12px 20px; background: rgba(0, 0, 0, 0.02);">
        <div class="d-flex justify-space-between align-center" style="width: 100%;">
            <MudButton Size="Size.Small" 
                       Variant="Variant.Text" 
                       Color="Color.Primary" 
                       OnClick="@OnViewDetails"
                       StartIcon="@Icons.Material.Filled.Visibility"
                       Style="text-transform: none; font-weight: 500; border-radius: 20px;">
                @Loc["Details"]
            </MudButton>
            @if (!IsPublicView)
            {
                <MudButton Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="@OnSyncTools"
                           Disabled="@IsSyncing"
                           StartIcon="@(IsSyncing ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Sync)"
                           Style="text-transform: none; font-weight: 600; border-radius: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    @(IsSyncing ? Loc["Syncing"] : Loc["Sync"])
                </MudButton>
            }
            else
            {
                <MudButton Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="@OnUseService"
                           StartIcon="@Icons.Material.Filled.Link"
                           Style="text-transform: none; font-weight: 600; border-radius: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    @Loc["UseThisService"]
                </MudButton>
            }
        </div>
    </MudCardActions>
</MudCard>

<style>
    .service-config-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    }
</style>

@code {
    [Parameter, EditorRequired]
    public McpServiceConfigDto Service { get; set; } = null!;
    
    [Parameter]
    public bool IsPublicView { get; set; } = false;
    
    [Parameter]
    public bool IsSyncing { get; set; } = false;
    
    [Parameter]
    public bool ShowAdminActions { get; set; } = false;
    
    [Parameter]
    public EventCallback OnViewDetails { get; set; }
    
    [Parameter]
    public EventCallback OnSyncTools { get; set; }
    
    [Parameter]
    public EventCallback OnEdit { get; set; }
    
    [Parameter]
    public EventCallback OnDelete { get; set; }
    
    [Parameter]
    public EventCallback OnSetPublic { get; set; }
    
    [Parameter]
    public EventCallback OnSetPrivate { get; set; }
    
    [Parameter]
    public EventCallback OnUseService { get; set; }

    /// <summary>
    /// 获取创建者显示名称
    /// </summary>
    private string GetCreatorName()
    {
        if (Service.Creator == null)
            return "Unknown";

        return Service.Creator.DisplayName 
            ?? Service.Creator.UserName 
            ?? Service.Creator.Email 
            ?? "Unknown";
    }

    /// <summary>
    /// 获取用户名首字母缩写（用于头像）
    /// </summary>
    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        
        if (parts.Length >= 2)
        {
            // 取前两个单词的首字母
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length > 0)
        {
            // 只有一个单词，取前两个字符或首字母
            return parts[0].Length > 1 
                ? parts[0].Substring(0, 2).ToUpper() 
                : parts[0][0].ToString().ToUpper();
        }

        return "?";
    }
}

