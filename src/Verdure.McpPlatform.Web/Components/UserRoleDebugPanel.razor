@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Verdure.McpPlatform.Web.Extensions
@using MudBlazor
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IConfiguration Configuration

<MudPaper Class="pa-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Class="mr-2" />
        ç”¨æˆ·è§’è‰²ä¿¡æ¯ (è°ƒè¯•)
    </MudText>

    @if (_authState != null && _authState.User.Identity?.IsAuthenticated == true)
    {
        <MudGrid>
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.body2"><strong>ç”¨æˆ·å:</strong> @_authState.User.GetUsername()</MudText>
                    <MudText Typo="Typo.body2"><strong>é‚®ç®±:</strong> @_authState.User.GetEmail()</MudText>
                    <MudText Typo="Typo.body2"><strong>ç”¨æˆ·ID:</strong> @_authState.User.GetUserId()</MudText>
                </MudAlert>
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    <strong>è§’è‰²åˆ—è¡¨:</strong>
                </MudText>
                @{
                    var roles = _authState.User.GetRoles();
                }
                @if (roles.Any())
                {
                    <MudChipSet T="string">
                        @foreach (var role in roles)
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@role</MudChip>
                        }
                    </MudChipSet>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        âš ï¸ æœªæ‰¾åˆ°è§’è‰²ä¿¡æ¯
                        <br/>
                        <small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ï¼ˆF12 â†’ Consoleï¼‰æŸ¥çœ‹è¯¦ç»†çš„è§’è‰²æ˜ å°„è¿‡ç¨‹</small>
                    </MudAlert>
                    
                    @* æ˜¾ç¤ºè°ƒè¯•æç¤º *@
                    <MudPaper Class="pa-3 mt-2" Style="background-color: #f5f5f5;">
                        <MudText Typo="Typo.caption" Style="font-family: monospace;">
                            <strong>è°ƒè¯•æ­¥éª¤ï¼š</strong><br/>
                            1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰<br/>
                            2. åˆ‡æ¢åˆ° Console æ ‡ç­¾<br/>
                            3. æœç´¢ "ğŸ” Mapping" æŸ¥çœ‹è§’è‰²æ˜ å°„æ—¥å¿—<br/>
                            4. æŸ¥çœ‹æ˜¯å¦æœ‰ "resource_access" claim<br/>
                            5. æ£€æŸ¥ ClientId æ˜¯å¦åŒ¹é…<br/>
                            6. æŸ¥çœ‹ "Available clients" åˆ—è¡¨
                        </MudText>
                    </MudPaper>
                }
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    <strong>æƒé™æ£€æŸ¥:</strong>
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem T="string" Icon="@(_authState.User.IsAdmin() ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                 IconColor="@(_authState.User.IsAdmin() ? Color.Success : Color.Default)">
                        IsAdmin(): @_authState.User.IsAdmin()
                    </MudListItem>
                    <MudListItem T="string" Icon="@(_authState.User.IsInRole("Admin") ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                 IconColor="@(_authState.User.IsInRole("Admin") ? Color.Success : Color.Default)">
                        IsInRole("Admin"): @_authState.User.IsInRole("Admin")
                    </MudListItem>
                    <MudListItem T="string" Icon="@(_authState.User.HasAnyRole("Admin", "User") ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                 IconColor="@(_authState.User.HasAnyRole("Admin", "User") ? Color.Success : Color.Default)">
                        HasAnyRole("Admin", "User"): @_authState.User.HasAnyRole("Admin", "User")
                    </MudListItem>
                </MudList>
            </MudItem>

            <MudItem xs="12">
                <MudExpansionPanels>
                    <MudExpansionPanel Text="æ‰€æœ‰ Claims (è¯¦ç»†)" IsInitiallyExpanded="true">
                        <MudSimpleTable Dense="true" Hover="true" Style="font-size: 0.8rem;">
                            <thead>
                                <tr>
                                    <th>Claim Type</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var claim in _authState.User.Claims.OrderBy(c => c.Type))
                                {
                                    <tr style="@(claim.Type == "resource_access" || claim.Type == "realm_access" ? "background-color: #fff3cd;" : "")">
                                        <td style="font-family: monospace; font-weight: @(claim.Type.Contains("role") || claim.Type == "resource_access" ? "bold" : "normal")">
                                            @claim.Type
                                            @if (claim.Type == "resource_access" || claim.Type == "realm_access")
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">é‡è¦</MudChip>
                                            }
                                        </td>
                                        <td style="word-break: break-all; max-width: 600px;">
                                            @if (claim.Value.Length > 300)
                                            {
                                                <details>
                                                    <summary style="cursor: pointer;">@claim.Value.Substring(0, 100)... (ç‚¹å‡»å±•å¼€)</summary>
                                                    <pre style="white-space: pre-wrap; margin-top: 8px;">@claim.Value</pre>
                                                </details>
                                            }
                                            else
                                            {
                                                @claim.Value
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudExpansionPanel>
                    
                    <MudExpansionPanel Text="é…ç½®ä¿¡æ¯">
                        <MudSimpleTable Dense="true">
                            <tbody>
                                <tr>
                                    <td><strong>å½“å‰ ClientId:</strong></td>
                                    <td style="font-family: monospace;">@_clientId</td>
                                </tr>
                                <tr>
                                    <td><strong>Role Claim Type:</strong></td>
                                    <td style="font-family: monospace;">
                                        @if (_authState.User.Identity is ClaimsIdentity identity)
                                        {
                                            @identity.RoleClaimType
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </MudSimpleTable>
                        
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            <MudText Typo="Typo.caption">
                                <strong>è¯´æ˜ï¼š</strong><br/>
                                â€¢ é»„è‰²é«˜äº®çš„ Claims åŒ…å«è§’è‰²ä¿¡æ¯<br/>
                                â€¢ resource_access åº”è¯¥åŒ…å« "@_clientId" å±æ€§<br/>
                                â€¢ å¦‚æœ ClientId ä¸åŒ¹é…ï¼Œè§’è‰²æ˜ å°„å°†å¤±è´¥
                            </MudText>
                        </MudAlert>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">
            ç”¨æˆ·æœªç™»å½•
        </MudAlert>
    }
</MudPaper>

@code {
    private AuthenticationState? _authState;
    private string _clientId = "æœªé…ç½®";

    protected override async Task OnInitializedAsync()
    {
        _authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _clientId = Configuration["Oidc:ClientId"] ?? "verdure-mcp";
    }
}
