@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Contracts.DTOs
@using Verdure.McpPlatform.Web.Resources
@inject IStringLocalizer<SharedResources> Loc

<MudCard Elevation="2" 
         Class="@($"connection-selector-card m3-card-elevated {(IsSelected ? "selected" : "")}")" 
         Style="@GetCardStyle()"
         @onclick="@(() => OnSelect.InvokeAsync())">
    
    <!-- Header with Status Indicator -->
    <MudCardHeader Style="@GetHeaderStyle()">
        <CardHeaderContent>
            <div class="d-flex align-center justify-space-between" style="width: 100%;">
                <div class="d-flex align-center" style="gap: 12px; flex: 1; min-width: 0;">
                    <!-- Connection Icon with Status Dot -->
                    <div style="position: relative;">
                        <MudIcon Icon="@Icons.Material.Outlined.Dns" 
                                 Size="Size.Medium" 
                                 Color="@(IsSelected ? Color.Primary : Color.Default)" />
                        @if (Connection.IsEnabled && Connection.IsConnected)
                        {
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: var(--m3-success); border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(var(--m3-success-rgb), 0.2);"></div>
                        }
                        else if (Connection.IsEnabled && !Connection.IsConnected)
                        {
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: var(--m3-warning); border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(var(--m3-warning-rgb), 0.2);"></div>
                        }
                    </div>
                    
                    <!-- Connection Name -->
                    <div style="flex: 1; min-width: 0;">
                        <MudText Typo="Typo.subtitle1" 
                                 Style="font-weight: 600; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--m3-on-surface);">
                            @Connection.Name
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetStatusText()
                        </MudText>
                    </div>
                </div>
                
                <!-- Selection Indicator -->
                @if (IsSelected)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" 
                             Color="Color.Primary" 
                             Style="flex-shrink: 0;" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Outlined.RadioButtonUnchecked" 
                             Color="Color.Default" 
                             Style="flex-shrink: 0; opacity: 0.5;" />
                }
            </div>
        </CardHeaderContent>
    </MudCardHeader>
    
    <!-- Card Content -->
    <MudCardContent Style="flex-grow: 1; padding: 16px;">
        <!-- Description -->
        @if (!string.IsNullOrWhiteSpace(Connection.Description))
        {
            <MudText Typo="Typo.body2" 
                     Color="Color.Secondary" 
                     Class="mb-3" 
                     Style="line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 40px;">
                @Connection.Description
            </MudText>
        }
        else
        {
            <MudText Typo="Typo.body2" 
                     Color="Color.Secondary" 
                     Class="mb-3" 
                     Style="font-style: italic; opacity: 0.6; min-height: 40px;">
                @Loc["NoDescription"]
            </MudText>
        }
        
        <!-- Info Pills -->
        <div class="d-flex flex-wrap align-center" style="gap: 6px;">
            <!-- Connection Status -->
            @if (Connection.IsEnabled)
            {
                @if (Connection.IsConnected)
                {
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Variant="Variant.Text"
                             Style="background: var(--m3-success-container); color: var(--m3-success); font-size: 11px; height: 24px; border-radius: 12px;"
                             Icon="@Icons.Material.Filled.CheckCircle">
                        @Loc["Connected"]
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Variant="Variant.Text"
                             Style="background: var(--m3-warning-container); color: var(--m3-warning); font-size: 11px; height: 24px; border-radius: 12px;"
                             Icon="@Icons.Material.Filled.Warning">
                        @Loc["Disconnected"]
                    </MudChip>
                }
            }
            else
            {
                <MudChip T="string" 
                         Size="Size.Small" 
                         Variant="Variant.Text"
                         Style="background: var(--m3-surface-variant); color: var(--m3-on-surface-variant); font-size: 11px; height: 24px; border-radius: 12px;"
                         Icon="@Icons.Material.Filled.PowerSettingsNew">
                    @Loc["NotStarted"]
                </MudChip>
            }
            
            <!-- Bindings Count -->
            <MudChip T="string" 
                     Size="Size.Small" 
                     Variant="Variant.Text"
                     Style="background: rgba(var(--m3-primary-rgb), 0.08); color: var(--m3-primary); font-size: 11px; height: 24px; border-radius: 12px;"
                     Icon="@Icons.Material.Filled.Link">
                @string.Format(Loc["BindingsCount"], Connection.ServiceBindings.Count)
            </MudChip>
        </div>
    </MudCardContent>
</MudCard>

<style>
    .connection-selector-card {
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }
    
    .connection-selector-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    }
    
    .connection-selector-card.selected {
        border-color: var(--m3-primary);
        box-shadow: 0 4px 12px rgba(var(--m3-primary-rgb), 0.3) !important;
    }
</style>

@code {
    [Parameter, EditorRequired]
    public XiaozhiMcpEndpointDto Connection { get; set; } = null!;
    
    [Parameter]
    public bool IsSelected { get; set; }
    
    [Parameter]
    public EventCallback OnSelect { get; set; }
    
    private string GetCardStyle()
    {
        return "height: 100%; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden;";
    }
    
    private string GetHeaderStyle()
    {
        return IsSelected
            ? "background: linear-gradient(135deg, rgba(var(--m3-primary-rgb), 0.15) 0%, rgba(var(--m3-primary-rgb), 0.08) 100%); padding: 16px;"
            : "background: linear-gradient(135deg, rgba(var(--m3-primary-rgb), 0.08) 0%, rgba(var(--m3-primary-rgb), 0.03) 100%); padding: 16px;";
    }
    
    private string GetStatusText()
    {
        if (!Connection.IsEnabled)
            return Loc["NotStarted"];
        
        return Connection.IsConnected ? Loc["Connected"] : Loc["Disconnected"];
    }
}
