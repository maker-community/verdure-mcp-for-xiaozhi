@using Microsoft.Extensions.Localization
@using Verdure.McpPlatform.Web.Resources
@using Verdure.McpPlatform.Web.Icons
@inherits LayoutComponentBase
@inject IStringLocalizer<SharedResources> Loc

<MudThemeProvider Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Style="min-height: 100vh; display: flex; flex-direction: column;">
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <!-- Logo 和标题：窄屏时移除 gap 以节省空间 -->
        <div class="d-flex align-center ml-3" style="gap: 0;">
            <img src="app-logo.png" 
                 alt="Verdure Logo" 
                 style="width: 32px; height: 32px; filter: brightness(0) invert(1);" />
            <!-- 应用标题：在手机等窄屏幕设备上隐藏，以节省空间 -->
            <MudText Typo="Typo.h6" Class="d-none d-sm-block" Style="margin-left: 0.5rem;">@Loc["AppTitle"]</MudText>
        </div>
        <MudSpacer />
        <div class="d-flex align-center gap-2">
            <!-- 社区链接 -->
            <MudTooltip Text="@Loc["TooltipGitHubCommunity"]">
                <MudIconButton Icon="@Icons.Material.Filled.Groups" 
                              Color="Color.Inherit" 
                              Href="https://github.com/maker-community" 
                              Target="_blank" />
            </MudTooltip>
            <MudTooltip Text="@Loc["TooltipProjectSource"]">
                <MudIconButton Icon="@Icons.Custom.Brands.GitHub" 
                              Color="Color.Inherit" 
                              Href="https://github.com/maker-community/verdure-mcp-for-xiaozhi" 
                              Target="_blank" />
            </MudTooltip>
            <MudTooltip Text="@Loc["TooltipBilibiliChannel"]">
                <MudIconButton Icon="@VerdureIcons.SocialMedia.Bilibili" 
                              Color="Color.Inherit" 
                              Href="https://space.bilibili.com/25228512" 
                              Target="_blank" />
            </MudTooltip>
            <MudDivider Vertical="true" FlexItem="true" Style="height: 30px; margin: 0 8px;" />
            <CultureSelector TextColor="#FFFFFF" />
            <AuthorizeView>
                <Authorized>
                    <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                        <MudMenuItem>
                            <div class="d-flex flex-column pa-2">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.User.Identity?.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.User.FindFirst("email")?.Value</MudText>
                            </div>
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Href="/settings" Icon="@Icons.Material.Filled.Settings">@Loc["Settings"]</MudMenuItem>
                        <MudMenuItem Href="/logout" Icon="@Icons.Material.Filled.Logout">@Loc["Logout"]</MudMenuItem>
                    </MudMenu>
                </Authorized>
                <NotAuthorized>
                    <!-- 登录按钮：窄屏仅图标，宽屏带文字 -->
                    <MudIconButton Icon="@Icons.Material.Filled.Login"
                                  Size="Size.Medium"
                                  Color="Color.Inherit"
                                  Href="/login"
                                  Class="d-inline-flex d-sm-none" />
                    <MudButton Href="/login" 
                              Variant="Variant.Text" 
                              Color="Color.Inherit" 
                              StartIcon="@Icons.Material.Filled.Login"
                              Size="Size.Small"
                              Class="d-none d-sm-inline-flex">
                        @Loc["Login"]
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" Elevation="1" ClipMode="DrawerClipMode.Always">
        <NavMenu />
    </MudDrawer>
    
    <MudMainContent Style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
        <!-- 主内容区域 - flex-grow: 1 确保占据剩余空间 -->
        <div style="flex: 1; padding: 1rem;">
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-6">
                @Body
            </MudContainer>
        </div>
        
        <!-- Footer 始终在底部 -->
        <Footer IsCompact="true" />
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            // M3 Primary - Modern Azure
            Primary = "#2F6FED",
            PrimaryContrastText = "#FFFFFF",
            PrimaryDarken = "#1C4FD8",
            PrimaryLighten = "#C5D7FF",
            
            // M3 Secondary - Muted Slate
            Secondary = "#4C6A7D",
            SecondaryContrastText = "#FFFFFF",
            SecondaryDarken = "#344B58",
            SecondaryLighten = "#C9D5DC",
            
            // M3 Tertiary - Warm Terracotta
            Tertiary = "#C26A3C",
            TertiaryContrastText = "#FFFFFF",
            TertiaryDarken = "#9A4F2C",
            TertiaryLighten = "#F3D3C4",
            
            // M3 Surface
            Surface = "#FFFFFF",
            Background = "#F7F8FA",
            AppbarBackground = "#2F6FED",
            DrawerBackground = "#FFFFFF",
            DrawerText = "#2B2F33",
            
            // Semantic colors
            Success = "#1E8E3E",
            Info = "#1A73E8",
            Warning = "#E37400",
            Error = "#B3261E",
            
            // Text colors
            TextPrimary = "#1E1F22",
            TextSecondary = "#5F6B76",
            TextDisabled = "#9AA3AB",
            
            // Borders and dividers
            Divider = "#E3E7EC",
            DividerLight = "#F1F4F7",
            
            // Actions
            ActionDefault = "#5F6B76",
            ActionDisabled = "rgba(0, 0, 0, 0.26)",
            ActionDisabledBackground = "rgba(0, 0, 0, 0.12)",
            
            // Hover
            HoverOpacity = 0.04,
        },
        
        PaletteDark = new PaletteDark()
        {
            Primary = "#A9C7FF",
            PrimaryContrastText = "#0B1B3F",
            PrimaryDarken = "#7FA8FF",
            PrimaryLighten = "#2F6FED",
            
            Secondary = "#B0C3CF",
            SecondaryContrastText = "#1F2D36",
            SecondaryDarken = "#8CA5B6",
            SecondaryLighten = "#4C6A7D",
            
            Tertiary = "#F2B79A",
            TertiaryContrastText = "#3A2216",
            TertiaryDarken = "#D99A7A",
            TertiaryLighten = "#C26A3C",
            
            Surface = "#121417",
            Background = "#0E1114",
            AppbarBackground = "#121417",
            DrawerBackground = "#121417",
            DrawerText = "#E7ECF1",
            
            Success = "#6DD58C",
            Info = "#7CB5FF",
            Warning = "#F6B26B",
            Error = "#F2B8B5",
            
            TextPrimary = "#E7ECF1",
            TextSecondary = "#B3BDC6",
            TextDisabled = "#7B8790",
            
            Divider = "#2A3137",
            DividerLight = "#1E2429",
            
            ActionDefault = "#E7ECF1",
            ActionDisabled = "rgba(255, 255, 255, 0.3)",
            ActionDisabledBackground = "rgba(255, 255, 255, 0.12)",
            
            HoverOpacity = 0.08,
        },
        
        // 从 MudBlazor 官方源码复制的正确 Shadows 配置
        // https://github.com/MudBlazor/MudBlazor/blob/main/src/MudBlazor/Themes/Models/Shadow.cs
        Shadows = new Shadow()
        {
            Elevation = new string[]
            {
                "none",
                "0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12)",
                "0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12)",
                "0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12)",
                "0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)",
                "0px 3px 5px -1px rgba(0,0,0,0.2),0px 5px 8px 0px rgba(0,0,0,0.14),0px 1px 14px 0px rgba(0,0,0,0.12)",
                "0px 3px 5px -1px rgba(0,0,0,0.2),0px 6px 10px 0px rgba(0,0,0,0.14),0px 1px 18px 0px rgba(0,0,0,0.12)",
                "0px 4px 5px -2px rgba(0,0,0,0.2),0px 7px 10px 1px rgba(0,0,0,0.14),0px 2px 16px 1px rgba(0,0,0,0.12)",
                "0px 5px 5px -3px rgba(0,0,0,0.2),0px 8px 10px 1px rgba(0,0,0,0.14),0px 3px 14px 2px rgba(0,0,0,0.12)",
                "0px 5px 6px -3px rgba(0,0,0,0.2),0px 9px 12px 1px rgba(0,0,0,0.14),0px 3px 16px 2px rgba(0,0,0,0.12)",
                "0px 6px 6px -3px rgba(0,0,0,0.2),0px 10px 14px 1px rgba(0,0,0,0.14),0px 4px 18px 3px rgba(0,0,0,0.12)",
                "0px 6px 7px -4px rgba(0,0,0,0.2),0px 11px 15px 1px rgba(0,0,0,0.14),0px 4px 20px 3px rgba(0,0,0,0.12)",
                "0px 7px 8px -4px rgba(0,0,0,0.2),0px 12px 17px 2px rgba(0,0,0,0.14),0px 5px 22px 4px rgba(0,0,0,0.12)",
                "0px 7px 8px -4px rgba(0,0,0,0.2),0px 13px 19px 2px rgba(0,0,0,0.14),0px 5px 24px 4px rgba(0,0,0,0.12)",
                "0px 7px 9px -4px rgba(0,0,0,0.2),0px 14px 21px 2px rgba(0,0,0,0.14),0px 5px 26px 4px rgba(0,0,0,0.12)",
                "0px 8px 9px -5px rgba(0,0,0,0.2),0px 15px 22px 2px rgba(0,0,0,0.14),0px 6px 28px 5px rgba(0,0,0,0.12)",
                "0px 8px 10px -5px rgba(0,0,0,0.2),0px 16px 24px 2px rgba(0,0,0,0.14),0px 6px 30px 5px rgba(0,0,0,0.12)",
                "0px 8px 11px -5px rgba(0,0,0,0.2),0px 17px 26px 2px rgba(0,0,0,0.14),0px 6px 32px 5px rgba(0,0,0,0.12)",
                "0px 9px 11px -5px rgba(0,0,0,0.2),0px 18px 28px 2px rgba(0,0,0,0.14),0px 7px 34px 6px rgba(0,0,0,0.12)",
                "0px 9px 12px -6px rgba(0,0,0,0.2),0px 19px 29px 2px rgba(0,0,0,0.14),0px 7px 36px 6px rgba(0,0,0,0.12)",
                "0px 10px 13px -6px rgba(0,0,0,0.2),0px 20px 31px 3px rgba(0,0,0,0.14),0px 8px 38px 7px rgba(0,0,0,0.12)",
                "0px 10px 13px -6px rgba(0,0,0,0.2),0px 21px 33px 3px rgba(0,0,0,0.14),0px 8px 40px 7px rgba(0,0,0,0.12)",
                "0px 10px 14px -6px rgba(0,0,0,0.2),0px 22px 35px 3px rgba(0,0,0,0.14),0px 8px 42px 7px rgba(0,0,0,0.12)",
                "0px 11px 14px -7px rgba(0,0,0,0.2),0px 23px 36px 3px rgba(0,0,0,0.14),0px 9px 44px 8px rgba(0,0,0,0.12)",
                "0px 11px 15px -7px rgba(0,0,0,0.2),0px 24px 38px 3px rgba(0,0,0,0.14),0px 9px 46px 8px rgba(0,0,0,0.12)",
                "0 5px 5px -3px rgba(0,0,0,.06), 0 8px 10px 1px rgba(0,0,0,.042), 0 3px 14px 2px rgba(0,0,0,.036)"
            }
        },
        
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "8px",
            AppbarHeight = "64px",
            DrawerWidthLeft = "260px",
            DrawerWidthRight = "260px",
        }
    };

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }
}
