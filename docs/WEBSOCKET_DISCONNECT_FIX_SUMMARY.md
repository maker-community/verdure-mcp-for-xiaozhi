# WebSocket æ–­å¼€æ£€æµ‹ä¿®å¤æ€»ç»“

## ğŸ¯ ä¿®å¤ç›®æ ‡

è§£å†³ WebSocket è¿æ¥æ–­å¼€åçŠ¶æ€æœªæ›´æ–°çš„é—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶æ£€æµ‹æ–­å¼€å¹¶è§¦å‘é‡è¿æœºåˆ¶ã€‚

## ğŸ”§ å®æ–½çš„ä¿®å¤

### ä¿®å¤ 1ï¼šæ·»åŠ  OnDisconnected å›è°ƒäº‹ä»¶

**æ–‡ä»¶**ï¼š`McpSessionService.cs`

**æ”¹åŠ¨**ï¼š
- æ·»åŠ  `OnDisconnected` äº‹ä»¶
- åœ¨è¿æ¥ç»“æŸæ—¶è§¦å‘è¯¥äº‹ä»¶
- åœ¨è¿æ¥æ–­å¼€æ—¶ç«‹å³é€šçŸ¥ SessionManager

**æ•ˆæœ**ï¼š
- âœ… è¿æ¥æ–­å¼€æ—¶ç«‹å³è§¦å‘å›è°ƒ
- âœ… ä¸ä¾èµ–åå°ç›‘æ§çš„å®šæ—¶æ£€æŸ¥
- âœ… 0ç§’å»¶è¿Ÿçš„çŠ¶æ€æ›´æ–°

### ä¿®å¤ 2ï¼šåœ¨ McpSessionManager ä¸­å¤„ç† OnDisconnected

**æ–‡ä»¶**ï¼š`McpSessionManager.cs`

**æ”¹åŠ¨**ï¼š
- æ³¨å†Œ `OnDisconnected` å›è°ƒå¤„ç†å™¨
- å›è°ƒä¸­æ›´æ–°æ•°æ®åº“ `IsConnected = false`
- å›è°ƒä¸­æ›´æ–° Redis `Status = Disconnected`

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“çŠ¶æ€ç«‹å³åŒæ­¥
- âœ… Redis çŠ¶æ€ç«‹å³åŒæ­¥
- âœ… UI å¯ä»¥ç«‹å³æ˜¾ç¤ºæ–­å¼€çŠ¶æ€

### ä¿®å¤ 3ï¼šä¼˜åŒ–åå°ç›‘æ§æœåŠ¡ï¼ˆå…³é”®ä¿®å¤ï¼‰

**æ–‡ä»¶**ï¼š`ConnectionMonitorHostedService.cs`

**æ”¹åŠ¨å‰**ï¼š
```csharp
if (session.Value.IsConnected)  // âŒ åªæ›´æ–°è¿æ¥æ­£å¸¸çš„
{
    await UpdateHeartbeatAsync(...);
}
// âŒ æ–­å¼€çš„è¿æ¥ä¸å¤„ç†ï¼Œå¯¼è‡´æ°¸è¿œä¸ä¼šé‡è¿
```

**æ”¹åŠ¨å**ï¼š
```csharp
if (session.Value.IsConnected)
{
    await UpdateHeartbeatAsync(...);  // âœ… æ›´æ–°å¿ƒè·³
}
else
{
    // âœ… æ£€æµ‹åˆ°æ–­å¼€
    await UpdateConnectionStatusAsync(..., Disconnected);
    await StopSessionAsync(...);  // âœ… æ¸…ç†æ–­å¼€çš„ session
}
```

**æ•ˆæœ**ï¼š
- âœ… æ¯ 30 ç§’æ£€æŸ¥æ‰€æœ‰æœ¬åœ° session
- âœ… ç«‹å³æ£€æµ‹æ–­å¼€çš„è¿æ¥
- âœ… æ›´æ–° Redis çŠ¶æ€
- âœ… æ¸…ç†æœ¬åœ° session å¯¹è±¡
- âœ… å…è®¸é‡è¿æœºåˆ¶æ¥ç®¡

### ä¿®å¤ 4ï¼šåœ¨ Ping å¤„ç†ä¸­æ£€æµ‹ WebSocket çŠ¶æ€

**æ–‡ä»¶**ï¼š`McpSessionService.cs` - `HandlePingAsync` æ–¹æ³•

**æ”¹åŠ¨**ï¼š
```csharp
// âœ… åœ¨å¤„ç† ping å‰å…ˆæ£€æŸ¥ WebSocket çŠ¶æ€
if (_webSocket?.State != WebSocketState.Open)
{
    _logger.LogError("WebSocket is not open (state: {State})", _webSocket?.State);
    throw new InvalidOperationException(...);  // âœ… è§¦å‘é‡è¿
}
```

**æ•ˆæœ**ï¼š
- âœ… å°æ™ºå‘é€ ping æ—¶ç«‹å³æ£€æµ‹æ–­å¼€
- âœ… æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¿æœºåˆ¶
- âœ… ä¸ä¼šé™é»˜å¤±è´¥

### ä¿®å¤ 5ï¼šå¢å¼º SendWebSocketResponseAsync é”™è¯¯å¤„ç†

**æ–‡ä»¶**ï¼š`McpSessionService.cs`

**æ”¹åŠ¨å‰**ï¼š
```csharp
if (_webSocket?.State != WebSocketState.Open) return;  // âŒ é™é»˜è¿”å›
```

**æ”¹åŠ¨å**ï¼š
```csharp
if (_webSocket?.State != WebSocketState.Open)
{
    _logger.LogError("Cannot send response, state is {State}", _webSocket?.State);
    throw new InvalidOperationException(...);  // âœ… æŠ›å‡ºå¼‚å¸¸
}
```

**æ•ˆæœ**ï¼š
- âœ… ä¸å†é™é»˜å¤±è´¥
- âœ… å‘é€å¤±è´¥æ—¶è§¦å‘å¼‚å¸¸
- âœ… å¼‚å¸¸ä¼šè§¦å‘é‡è¿æœºåˆ¶

### ä¿®å¤ 6ï¼šå¢å¼ºæ—¥å¿—è®°å½•

**æ–‡ä»¶**ï¼š`McpSessionService.cs`

**æ”¹åŠ¨**ï¼š
- WebSocket å…³é—­æ—¶è®°å½• CloseStatus å’Œ CloseDescription
- é”™è¯¯å¤„ç†ä¸­è®°å½• WebSocket State
- æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯

**æ•ˆæœ**ï¼š
- âœ… æ›´å®¹æ˜“æ’æŸ¥é—®é¢˜
- âœ… äº†è§£æ–­å¼€çš„åŸå› 
- âœ… è¿½è¸ªçŠ¶æ€å˜åŒ–

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### æ–­å¼€æ£€æµ‹å»¶è¿Ÿ

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| WebSocket æ­£å¸¸å…³é—­ | 90ç§’ï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰ | **0ç§’**ï¼ˆç«‹å³æ£€æµ‹ï¼‰ |
| Ping å¤±è´¥ | ä¸æ£€æµ‹ | **0ç§’**ï¼ˆç«‹å³æ£€æµ‹ï¼‰ |
| ç½‘ç»œä¸­æ–­ | 90ç§’ï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰ | **æœ€å¤š30ç§’**ï¼ˆåå°ç›‘æ§ï¼‰ |
| é™é»˜æ–­å¼€ | æ°¸ä¸æ¢å¤ | **30ç§’**ï¼ˆåå°ç›‘æ§ï¼‰ |

### çŠ¶æ€æ›´æ–°

| ç»„ä»¶ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ•°æ®åº“ IsConnected | âŒ ä¸æ›´æ–° | âœ… ç«‹å³æ›´æ–° |
| Redis Status | âŒ ä¸æ›´æ–° | âœ… ç«‹å³æ›´æ–° |
| æœ¬åœ° Session | âŒ æ°¸ä¹…ä¿ç•™ | âœ… 30ç§’å†…æ¸…ç† |
| é‡è¿æœºåˆ¶ | âŒ ä¸è§¦å‘ | âœ… 60ç§’åé‡è¿ |

### é‡è¿æ¢å¤æ—¶é—´

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å°æ™ºæœåŠ¡å™¨é‡å¯ | æ°¸ä¸æ¢å¤ | **60ç§’åè‡ªåŠ¨é‡è¿** |
| ç½‘ç»œæ¢å¤ | æ°¸ä¸æ¢å¤ | **90ç§’åè‡ªåŠ¨é‡è¿** (30sæ£€æµ‹ + 60så†·å´) |
| ç¬æ—¶æ•…éšœ | æ°¸ä¸æ¢å¤ | **è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š10æ¬¡å°è¯•ï¼‰** |

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```powershell
.\scripts\test-disconnect-detection.ps1
```

### æµ‹è¯•åœºæ™¯ 1ï¼šå°æ™ºæœåŠ¡å™¨ä¸»åŠ¨å…³é—­

**æ­¥éª¤**ï¼š
1. å¯åŠ¨è¿æ¥
2. å…³é—­å°æ™ºæœåŠ¡å™¨
3. è§‚å¯Ÿæ—¥å¿—

**é¢„æœŸæ—¥å¿—**ï¼š
```
[Information] Server xxx: WebSocket closed by server with status NormalClosure
[Warning] Server xxx: WebSocket connection ended, triggering disconnect notification
[Warning] Session for server xxx disconnected
[Debug] Updated database status to Disconnected for server xxx
[Information] Successfully updated disconnect status in Redis
```

**é¢„æœŸæ—¶é—´**ï¼š**< 1ç§’**

### æµ‹è¯•åœºæ™¯ 2ï¼šPing è¯·æ±‚æ£€æµ‹æ–­å¼€

**æ­¥éª¤**ï¼š
1. å»ºç«‹è¿æ¥
2. ç½‘ç»œä¸­æ–­ï¼ˆä½†ä¸å‘é€ Closeï¼‰
3. ç­‰å¾…å°æ™ºå‘é€ ping

**é¢„æœŸæ—¥å¿—**ï¼š
```
[Error] Server xxx: Received ping but WebSocket is not open (state: Aborted)
[Error] Server xxx: Error in WebSocket to MCP pipe: WebSocket state is Aborted
[Warning] Server xxx disconnected
```

**é¢„æœŸæ—¶é—´**ï¼š**ä¸‹æ¬¡ ping æ—¶ç«‹å³æ£€æµ‹ï¼ˆé€šå¸¸ < 30ç§’ï¼‰**

### æµ‹è¯•åœºæ™¯ 3ï¼šåå°ç›‘æ§æ£€æµ‹

**æ­¥éª¤**ï¼š
1. å»ºç«‹è¿æ¥
2. æ¨¡æ‹Ÿé™é»˜æ–­å¼€ï¼ˆsession åœ¨å†…å­˜ä½† WebSocket æ–­å¼€ï¼‰
3. ç­‰å¾… 30 ç§’

**é¢„æœŸæ—¥å¿—**ï¼š
```
[Warning] Detected disconnected session for server xxx in local heartbeat check
[Information] Removing disconnected session from local manager
[Warning] Session for server xxx disconnected
```

**é¢„æœŸæ—¶é—´**ï¼š**æœ€å¤š 30ç§’ï¼ˆä¸‹æ¬¡ç›‘æ§å‘¨æœŸï¼‰**

## ğŸ”„ å®Œæ•´çš„æ•…éšœæ¢å¤æµç¨‹

### æµç¨‹å›¾

```
WebSocket æ–­å¼€
    â†“
[ç«‹å³] OnDisconnected å›è°ƒè§¦å‘
    â†“
[ç«‹å³] æ›´æ–°æ•°æ®åº“ IsConnected = false
    â†“
[ç«‹å³] æ›´æ–° Redis Status = Disconnected
    â†“
[30ç§’å†…] åå°ç›‘æ§æ£€æµ‹åˆ°æ–­å¼€
    â†“
[ç«‹å³] æ¸…ç†æœ¬åœ° session å¯¹è±¡
    â†“
[ç«‹å³] Redis Status ç¡®è®¤ä¸º Disconnected
    â†“
[60ç§’å] å†·å´æœŸç»“æŸ
    â†“
[ç«‹å³] åå°ç›‘æ§è§¦å‘é‡è¿
    â†“
[ç«‹å³] StartSessionAsync å°è¯•è¿æ¥
    â†“
æˆåŠŸï¼šOnConnected â†’ æ›´æ–°çŠ¶æ€ä¸º Connected
å¤±è´¥ï¼šOnConnectionFailed â†’ ç­‰å¾…ä¸‹æ¬¡é‡è¿
```

### æ—¶é—´çº¿

| æ—¶é—´ | äº‹ä»¶ |
|------|------|
| T+0s | WebSocket æ–­å¼€ |
| T+0s | OnDisconnected å›è°ƒ |
| T+0s | æ•°æ®åº“ + Redis æ›´æ–° |
| T+0-30s | åå°ç›‘æ§æ£€æµ‹ |
| T+30s | æ¸…ç† session |
| T+90s | å†·å´æœŸç»“æŸ |
| T+90s | é¦–æ¬¡é‡è¿å°è¯• |
| T+91s | è¿æ¥æ¢å¤ï¼ˆå¦‚æœæœåŠ¡å¯ç”¨ï¼‰ |

**æ€»æ¢å¤æ—¶é—´ï¼šçº¦ 90-120 ç§’**ï¼ˆæ¯”ä¿®å¤å‰çš„"æ°¸ä¸æ¢å¤"å¥½å¾ˆå¤šï¼ï¼‰

## ğŸ“ é…ç½®å‚æ•°

æ‰€æœ‰æ—¶é—´å‚æ•°åœ¨ `appsettings.json` ä¸­é…ç½®ï¼š

```json
{
  "ConnectionMonitor": {
    "CheckIntervalSeconds": 30,      // åå°ç›‘æ§æ£€æŸ¥é—´éš”
    "HeartbeatTimeoutSeconds": 90,   // å¿ƒè·³è¶…æ—¶åˆ¤å®š
    "ReconnectCooldownSeconds": 60   // é‡è¿å†·å´æœŸ
  }
}
```

**å»ºè®®é…ç½®**ï¼ˆæ›´å¿«æ¢å¤ï¼‰ï¼š
```json
{
  "ConnectionMonitor": {
    "CheckIntervalSeconds": 15,      // 15ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆæ›´å¿«å‘ç°ï¼‰
    "HeartbeatTimeoutSeconds": 45,   // 45ç§’è¶…æ—¶ï¼ˆæ›´å¿«åˆ¤å®šï¼‰
    "ReconnectCooldownSeconds": 30   // 30ç§’å†·å´ï¼ˆæ›´å¿«é‡è¿ï¼‰
  }
}
```

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„

ä½¿ç”¨äº‹ä»¶å›è°ƒï¼ˆOnConnected/OnDisconnected/OnConnectionFailedï¼‰å®ç°æ¾è€¦åˆï¼š
- McpSessionService è´Ÿè´£æ£€æµ‹çŠ¶æ€å˜åŒ–
- McpSessionManager è´Ÿè´£å¤„ç†çŠ¶æ€æ›´æ–°
- åˆ†å±‚æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

### 2. å¤šå±‚æ£€æµ‹æœºåˆ¶

ä¸‰å±‚æ£€æµ‹ç¡®ä¿ä¸ä¼šé—æ¼ï¼š
1. **å³æ—¶å±‚**ï¼šOnDisconnected å›è°ƒï¼ˆ0ç§’ï¼‰
2. **å¿«é€Ÿå±‚**ï¼šPing å¤„ç†æ£€æµ‹ï¼ˆ< 30ç§’ï¼‰
3. **å…œåº•å±‚**ï¼šåå°ç›‘æ§ï¼ˆ30ç§’å‘¨æœŸï¼‰

### 3. çŠ¶æ€ä¸€è‡´æ€§

ç¡®ä¿ä¸‰ä¸ªçŠ¶æ€å­˜å‚¨åŒæ­¥ï¼š
- æ•°æ®åº“ï¼ˆXiaozhiMcpEndpoint.IsConnectedï¼‰
- Redisï¼ˆConnectionStateInfo.Statusï¼‰
- å†…å­˜ï¼ˆMcpSessionService.IsConnectedï¼‰

### 4. é˜²æ­¢é‡å¤é‡è¿

ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆRedLockï¼‰é˜²æ­¢å¤šå®ä¾‹åŒæ—¶é‡è¿åŒä¸€æœåŠ¡å™¨ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†·å´æœŸçš„é‡è¦æ€§**ï¼š
   - é˜²æ­¢é¢‘ç¹é‡è¿å¯¼è‡´èµ„æºè€—å°½
   - ç»™æœåŠ¡å™¨æ—¶é—´æ¢å¤
   - é¿å…"è¿æ¥é£æš´"

2. **é‡è¿æœ€å¤§æ¬¡æ•°**ï¼š
   - é»˜è®¤ 10 æ¬¡
   - è¶…è¿‡ååœæ­¢é‡è¿
   - éœ€è¦æ‰‹åŠ¨é‡å¯

3. **æ—¥å¿—çº§åˆ«**ï¼š
   - ç”Ÿäº§ç¯å¢ƒå»ºè®® Information çº§åˆ«
   - æ’æŸ¥é—®é¢˜æ—¶å¯ä»¥å¼€å¯ Debug/Trace

4. **æ€§èƒ½å½±å“**ï¼š
   - åå°ç›‘æ§æ¯ 30 ç§’è¿è¡Œä¸€æ¬¡ï¼Œå½±å“å¾ˆå°
   - OnDisconnected å›è°ƒæ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡ä¸»æµç¨‹
   - åˆ†å¸ƒå¼é”ä¼šæœ‰è½»å¾®å»¶è¿Ÿï¼ˆ< 1ç§’ï¼‰

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå¯é€‰ï¼‰

1. **å¯è°ƒèŠ‚çš„æ£€æµ‹é—´éš”**ï¼š
   - UI ä¸­å…è®¸ç”¨æˆ·é…ç½®æ£€æµ‹é—´éš”
   - ä¸åŒæœåŠ¡å™¨ä¸åŒç­–ç•¥

2. **å¥åº·åº¦è¯„åˆ†**ï¼š
   - è®°å½•è¿æ¥ç¨³å®šæ€§
   - é¢‘ç¹æ–­å¼€çš„æœåŠ¡å™¨é™ä½ä¼˜å…ˆçº§

3. **é€šçŸ¥æœºåˆ¶**ï¼š
   - è¿æ¥æ–­å¼€æ—¶å‘é€é€šçŸ¥
   - å¤šæ¬¡é‡è¿å¤±è´¥æ—¶å‘Šè­¦

### é•¿æœŸï¼ˆé«˜çº§åŠŸèƒ½ï¼‰

1. **ä¸»åŠ¨å¥åº·æ£€æŸ¥**ï¼š
   - ä¸ç­‰ pingï¼Œä¸»åŠ¨å‘é€å¥åº·æ£€æŸ¥
   - æ¯ 10 ç§’æ£€æµ‹ä¸€æ¬¡

2. **æ–­è·¯å™¨æ¨¡å¼**ï¼š
   - è¿ç»­å¤±è´¥åæš‚æ—¶åœæ­¢é‡è¿
   - é¿å…é›ªå´©æ•ˆåº”

3. **è¿æ¥æ± **ï¼š
   - é¢„å»ºç«‹å¤‡ç”¨è¿æ¥
   - æ•…éšœæ—¶å¿«é€Ÿåˆ‡æ¢

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²åéœ€è¦éªŒè¯çš„é¡¹ç›®ï¼š

- [ ] WebSocket æ­£å¸¸å…³é—­èƒ½è¢«æ£€æµ‹åˆ°
- [ ] æ•°æ®åº“çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] Redis çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] UI æ˜¾ç¤ºæ­£ç¡®çš„è¿æ¥çŠ¶æ€
- [ ] Ping å¤±è´¥è§¦å‘é‡è¿
- [ ] åå°ç›‘æ§æ­£å¸¸è¿è¡Œ
- [ ] æ–­å¼€åèƒ½è‡ªåŠ¨é‡è¿
- [ ] å¤šå®ä¾‹éƒ¨ç½²ä¸‹ä¸ä¼šé‡å¤é‡è¿
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸ä¸”æœ‰æ„ä¹‰
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **ä»"æ°¸ä¸æ¢å¤"åˆ°"è‡ªåŠ¨æ¢å¤"**
2. **ä»"90ç§’æ£€æµ‹"åˆ°"0ç§’æ£€æµ‹"**
3. **ä»"çŠ¶æ€ä¸åŒæ­¥"åˆ°"ç«‹å³åŒæ­¥"**
4. **ä»"é™é»˜å¤±è´¥"åˆ°"ä¸»åŠ¨å‘Šè­¦"**

è¿™æ˜¯ä¸€ä¸ªä»**è¢«åŠ¨åº”å¯¹**åˆ°**ä¸»åŠ¨æ£€æµ‹**çš„è´¨çš„é£è·ƒï¼

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-14  
**ä¿®å¤è€…**ï¼šGitHub Copilot  
**çŠ¶æ€**ï¼šå·²å®æ–½ï¼Œå¾…æµ‹è¯•éªŒè¯
