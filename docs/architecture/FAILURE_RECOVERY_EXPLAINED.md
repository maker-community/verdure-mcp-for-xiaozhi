# WebSocket è¿æ¥æ•…éšœè‡ªåŠ¨æ¢å¤æœºåˆ¶è¯¦è§£

## æ ¸å¿ƒé—®é¢˜å›ç­”

**é—®é¢˜ 1**: å¦‚æœä¸‰ä¸ªæœåŠ¡éƒ½æœ‰å¯¹åº”çš„ Socket è¿æ¥ï¼Œä½†æ˜¯å…¶ä¸­ä¸€ä¸ªæœåŠ¡æŒ‚æ‰äº†ï¼Œæ˜¯ä¸æ˜¯é€šè¿‡åå°ä»»åŠ¡ä¼šè‡ªåŠ¨åœ¨å…¶ä»–çš„ä¸¤ä¸ªæœåŠ¡ä¸Šè¿›è¡Œé‡å»ºè¿æ¥ï¼Ÿ

**ç­”æ¡ˆ**: âœ… **æ˜¯çš„ï¼** å®Œå…¨æ­£ç¡®ã€‚åå°ç›‘æ§æœåŠ¡ (`ConnectionMonitorHostedService`) ä¼šè‡ªåŠ¨æ£€æµ‹æ•…éšœå¹¶åœ¨å­˜æ´»çš„å®ä¾‹ä¸Šé‡å»ºè¿æ¥ã€‚

**é—®é¢˜ 2**: å¦‚æœæ•°æ®åº“ä¸­æœåŠ¡å™¨å·²å¯ç”¨ä½† Redis ä¸­å®Œå…¨æ²¡æœ‰è¿æ¥çŠ¶æ€æ•°æ®ï¼Œä¼šè‡ªåŠ¨æ¢å¤å—ï¼Ÿ

**ç­”æ¡ˆ**: âœ… **æ˜¯çš„ï¼** æ–°å¢çš„ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶ä¼šä¸»åŠ¨å¯¹æ¯”æ•°æ®åº“å’Œ Redisï¼Œè‡ªåŠ¨æ¢å¤ç¼ºå¤±çš„è¿æ¥ã€‚

---

## ä¸‰å±‚æ¢å¤æœºåˆ¶

ç³»ç»Ÿæä¾›ä¸‰å±‚äº’è¡¥çš„æ¢å¤æœºåˆ¶ï¼Œç¡®ä¿è¿æ¥çš„é«˜å¯ç”¨æ€§ï¼š

### 1ï¸âƒ£ å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ï¼ˆå†·å¯åŠ¨æ¢å¤ï¼‰
- **è§¦å‘æ—¶æœº**: æœåŠ¡å¯åŠ¨å 10 ç§’
- **æ£€æŸ¥èŒƒå›´**: æ•°æ®åº“ä¸­æ‰€æœ‰ `IsEnabled=true` çš„æœåŠ¡å™¨
- **æ¢å¤æ¡ä»¶**: Redis ä¸­ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸æ˜¯ `Connected`
- **é€‚ç”¨åœºæ™¯**: å…¨æ–°éƒ¨ç½²ã€æœåŠ¡é‡å¯ã€é›†ç¾¤æ‰©å®¹

### 2ï¸âƒ£ ä¸€è‡´æ€§æ£€æŸ¥æ¢å¤ï¼ˆæ•°æ®ä¸¢å¤±æ¢å¤ï¼‰â­ NEW
- **è§¦å‘æ—¶æœº**: æ¯ä¸ªç›‘æ§å‘¨æœŸï¼ˆé»˜è®¤30ç§’ï¼‰
- **æ£€æŸ¥èŒƒå›´**: å¯¹æ¯”æ•°æ®åº“å¯ç”¨çš„æœåŠ¡å™¨å’Œ Redis è¿æ¥çŠ¶æ€
- **æ¢å¤æ¡ä»¶**: æ•°æ®åº“ä¸­å¯ç”¨ä½† Redis ä¸­ç¼ºå¤±
- **é€‚ç”¨åœºæ™¯**: Redis é‡å¯ã€æ‰‹åŠ¨æ¸…ç©ºã€è¿æ¥å¤±è´¥æœªç•™è®°å½•

### 3ï¸âƒ£ å¿ƒè·³è¶…æ—¶æ¢å¤ï¼ˆæ•…éšœè½¬ç§»æ¢å¤ï¼‰
- **è§¦å‘æ—¶æœº**: å¿ƒè·³è¶…è¿‡ 90 ç§’æœªæ›´æ–°
- **æ£€æŸ¥èŒƒå›´**: Redis ä¸­æ‰€æœ‰è¿æ¥çŠ¶æ€
- **æ¢å¤æ¡ä»¶**: å¿ƒè·³è¶…æ—¶ + å†·å´æœŸï¼ˆ60ç§’ï¼‰å·²è¿‡
- **é€‚ç”¨åœºæ™¯**: å®ä¾‹å´©æºƒã€è¿›ç¨‹ç»ˆæ­¢ã€ç½‘ç»œåˆ†åŒº

---

## è¯¦ç»†å·¥ä½œæµç¨‹

### åˆå§‹çŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   3ä¸ª API å®ä¾‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  å®ä¾‹ A (è¿è¡Œä¸­)          å®ä¾‹ B (è¿è¡Œä¸­)        å®ä¾‹ C (è¿è¡Œä¸­) â”‚
â”‚  â”œâ”€ Server-1 âœ…         â”œâ”€ Server-3 âœ…        â”œâ”€ Server-5 âœ…  â”‚
â”‚  â””â”€ Server-2 âœ…         â””â”€ Server-4 âœ…        â””â”€ Server-6 âœ…  â”‚
â”‚                                                          â”‚
â”‚  å¿ƒè·³: æ­£å¸¸              å¿ƒè·³: æ­£å¸¸            å¿ƒè·³: æ­£å¸¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Redis      â”‚
                    â”‚ (è¿æ¥çŠ¶æ€)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•…éšœå‘ç”Ÿ (T0)

```
å®ä¾‹ B å´©æºƒ âŒ
â”œâ”€ Server-3 çš„ WebSocket æ–­å¼€
â”œâ”€ Server-4 çš„ WebSocket æ–­å¼€
â””â”€ åœæ­¢å‘é€å¿ƒè·³åˆ° Redis

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A (è¿è¡Œä¸­)          å®ä¾‹ B (å´©æºƒâŒ)         å®ä¾‹ C (è¿è¡Œä¸­) â”‚
â”‚  â”œâ”€ Server-1 âœ…         â”œâ”€ Server-3 ğŸ’¥        â”œâ”€ Server-5 âœ…  â”‚
â”‚  â””â”€ Server-2 âœ…         â””â”€ Server-4 ğŸ’¥        â””â”€ Server-6 âœ…  â”‚
â”‚                                                          â”‚
â”‚  å¿ƒè·³: æ­£å¸¸              å¿ƒè·³: åœæ­¢ âš ï¸          å¿ƒè·³: æ­£å¸¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›‘æ§å¾ªç¯ç»§ç»­è¿è¡Œ (T0 + 30ç§’)

```
æ¯éš” 30 ç§’ (å¯é…ç½®):

å®ä¾‹ A çš„ç›‘æ§æœåŠ¡:
â”œâ”€ æ›´æ–°è‡ªå·±ç®¡ç†çš„è¿æ¥å¿ƒè·³ (Server-1, Server-2) âœ…
â”œâ”€ æ£€æŸ¥ Redis ä¸­æ‰€æœ‰è¿æ¥çŠ¶æ€
â””â”€ å‘ç° Server-3 å’Œ Server-4 çš„å¿ƒè·³æ—¶é—´æ˜¯ 30 ç§’å‰

å®ä¾‹ C çš„ç›‘æ§æœåŠ¡:
â”œâ”€ æ›´æ–°è‡ªå·±ç®¡ç†çš„è¿æ¥å¿ƒè·³ (Server-5, Server-6) âœ…
â”œâ”€ æ£€æŸ¥ Redis ä¸­æ‰€æœ‰è¿æ¥çŠ¶æ€
â””â”€ åŒæ ·å‘ç° Server-3 å’Œ Server-4 çš„å¿ƒè·³è¿‡æœŸ

æ­¤æ—¶ï¼šå°šæœªè¶…è¿‡å¿ƒè·³è¶…æ—¶æ—¶é—´ (90ç§’)ï¼Œç»§ç»­ç›‘æ§
```

### å¿ƒè·³è¶…æ—¶æ£€æµ‹ (T0 + 90ç§’)

```
å®ä¾‹ A çš„ç›‘æ§æœåŠ¡:
â”œâ”€ æ£€æµ‹åˆ° Server-3 å¿ƒè·³è¶…æ—¶ (90ç§’æœªæ›´æ–°) âš ï¸
â”œâ”€ æ£€æµ‹åˆ° Server-4 å¿ƒè·³è¶…æ—¶ (90ç§’æœªæ›´æ–°) âš ï¸
â”œâ”€ åˆ¤æ–­è¿™äº›æ˜¯åƒµå°¸è¿æ¥
â””â”€ æ¸…ç† Redis ä¸­çš„è¿æ¥çŠ¶æ€è®°å½•

å®ä¾‹ C çš„ç›‘æ§æœåŠ¡:
â”œâ”€ åŒæ ·æ£€æµ‹åˆ°è¶…æ—¶
â”œâ”€ åŒæ ·æ¸…ç†çŠ¶æ€
â””â”€ å‡†å¤‡å°è¯•é‡è¿

æ—¥å¿—è¾“å‡º:
[è­¦å‘Š] Stale connection detected for server Server-3, last heartbeat: 2025-11-05 10:00:00
[è­¦å‘Š] Stale connection detected for server Server-4, last heartbeat: 2025-11-05 10:00:00
[ä¿¡æ¯] Cleaning up stale connection state for Server-3
[ä¿¡æ¯] Cleaning up stale connection state for Server-4
```

### å†·å´æœŸç­‰å¾… (T0 + 90ç§’ åˆ° T0 + 150ç§’)

```
ä¸ºä»€ä¹ˆéœ€è¦å†·å´æœŸï¼Ÿ
â”œâ”€ é¿å…è¿‡äºé¢‘ç¹çš„é‡è¿å°è¯•
â”œâ”€ ç»™ç½‘ç»œé—®é¢˜ä¸€äº›æ¢å¤æ—¶é—´
â”œâ”€ é˜²æ­¢é‡è¿é£æš´
â””â”€ é»˜è®¤ 60 ç§’ (å¯é…ç½®)

åœ¨è¿™æœŸé—´:
â”œâ”€ å®ä¾‹ A å’Œ C ç»§ç»­æ­£å¸¸ç›‘æ§
â”œâ”€ æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡æ–­å¼€çš„è¿æ¥
â””â”€ åˆ¤æ–­å†·å´æœŸæ˜¯å¦å·²è¿‡
```

### å¼€å§‹é‡è¿ (T0 + 150ç§’)

```
å®ä¾‹ A å’Œ C å‡ ä¹åŒæ—¶å°è¯•é‡è¿:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é‡è¿ Server-3 çš„ç«äº‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  å®ä¾‹ A:                     å®ä¾‹ C:                  â”‚
â”‚  æ£€æµ‹åˆ° Server-3 æ–­å¼€  â†â”€â”€â†’  æ£€æµ‹åˆ° Server-3 æ–­å¼€     â”‚
â”‚  å†·å´æœŸå·²è¿‡                  å†·å´æœŸå·²è¿‡                â”‚
â”‚  å°è¯•è·å–åˆ†å¸ƒå¼é”            å°è¯•è·å–åˆ†å¸ƒå¼é”           â”‚
â”‚         â†“                           â†“                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚  Redis åˆ†å¸ƒå¼é”                  â”‚              â”‚
â”‚    â”‚  Key: mcp:lock:connection:3     â”‚              â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â†“                           â†“                â”‚
â”‚  âœ… è·å–æˆåŠŸ                    âŒ è·å–å¤±è´¥ï¼ˆå·²è¢«å ç”¨ï¼‰ â”‚
â”‚  å»ºç«‹è¿æ¥                        è·³è¿‡æ­¤è¿æ¥            â”‚
â”‚  æ³¨å†ŒçŠ¶æ€åˆ° Redis                                     â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¥å¿—è¾“å‡º (å®ä¾‹ A):
[ä¿¡æ¯] Attempting to reconnect server Server-3, attempt #1
[ä¿¡æ¯] Acquired distributed lock for server Server-3
[ä¿¡æ¯] Created session for server Server-3
[ä¿¡æ¯] Successfully reconnected server Server-3

æ—¥å¿—è¾“å‡º (å®ä¾‹ C):
[ä¿¡æ¯] Attempting to reconnect server Server-3, attempt #1
[è­¦å‘Š] Failed to acquire distributed lock for server Server-3
[ä¿¡æ¯] Server Server-3 is already connected on instance A
```

### ç»§ç»­é‡è¿å…¶ä»–æœåŠ¡ (T0 + 152ç§’)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é‡è¿ Server-4 çš„ç«äº‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  å®ä¾‹ A:                     å®ä¾‹ C:                  â”‚
â”‚  å·²ç»æŒæœ‰ Server-3           æ£€æµ‹åˆ° Server-4 æ–­å¼€     â”‚
â”‚  æ£€æµ‹åˆ° Server-4 æ–­å¼€        å°è¯•è·å–åˆ†å¸ƒå¼é”          â”‚
â”‚  å°è¯•è·å–åˆ†å¸ƒå¼é”                    â†“                â”‚
â”‚         â†“                   âœ… è·å–æˆåŠŸ               â”‚
â”‚    âŒ è·å–å¤±è´¥                å»ºç«‹è¿æ¥                 â”‚
â”‚    (è¢«å®ä¾‹ C å ç”¨)            æ³¨å†ŒçŠ¶æ€åˆ° Redis         â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¥å¿—è¾“å‡º (å®ä¾‹ C):
[ä¿¡æ¯] Attempting to reconnect server Server-4, attempt #1
[ä¿¡æ¯] Acquired distributed lock for server Server-4
[ä¿¡æ¯] Created session for server Server-4
[ä¿¡æ¯] Successfully reconnected server Server-4
```

### æœ€ç»ˆçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A (è¿è¡Œä¸­)          å®ä¾‹ B (å´©æºƒâŒ)         å®ä¾‹ C (è¿è¡Œä¸­) â”‚
â”‚  â”œâ”€ Server-1 âœ…         â”œâ”€ [å·²æ•…éšœ]            â”œâ”€ Server-5 âœ…  â”‚
â”‚  â”œâ”€ Server-2 âœ…         â””â”€ [å·²æ•…éšœ]            â”œâ”€ Server-6 âœ…  â”‚
â”‚  â””â”€ Server-3 âœ… (æ¥ç®¡)                         â””â”€ Server-4 âœ… (æ¥ç®¡) â”‚
â”‚                                                          â”‚
â”‚  å¿ƒè·³: æ­£å¸¸              å¿ƒè·³: åœæ­¢             å¿ƒè·³: æ­£å¸¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Redis      â”‚
                    â”‚  Server-1: A  â”‚
                    â”‚  Server-2: A  â”‚
                    â”‚  Server-3: A  â”‚ â† å·²æ¥ç®¡
                    â”‚  Server-4: C  â”‚ â† å·²æ¥ç®¡
                    â”‚  Server-5: C  â”‚
                    â”‚  Server-6: C  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æ‰€æœ‰è¿æ¥éƒ½å·²æ¢å¤ï¼
âœ… å®ä¾‹ B çš„è¿æ¥è¢«å…¶ä»–å®ä¾‹æ¥ç®¡
âœ… ç”¨æˆ·æœåŠ¡ä¸å—å½±å“
```

---

## å…³é”®æœºåˆ¶

### 1. ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶ â­ NEW

```csharp
// æ¯ä¸ªç›‘æ§å‘¨æœŸæ‰§è¡Œï¼ˆé»˜è®¤ 30 ç§’ï¼‰
private async Task CheckDatabaseRedisConsistencyAsync(...)
{
    // 1. è·å–æ•°æ®åº“ä¸­æ‰€æœ‰å¯ç”¨çš„æœåŠ¡å™¨
    var enabledServers = await serverRepository.GetEnabledServersAsync(cancellationToken);
    
    // 2. è·å– Redis ä¸­æ‰€æœ‰è¿æ¥çŠ¶æ€
    var allRedisStates = await connectionStateService.GetAllConnectionStatesAsync(cancellationToken);
    var redisServerIds = new HashSet<string>(allRedisStates.Select(s => s.ServerId));

    // 3. æ‰¾å‡ºæ•°æ®åº“å¯ç”¨ä½† Redis ç¼ºå¤±çš„æœåŠ¡å™¨
    var missingServers = enabledServers
        .Where(server => !redisServerIds.Contains(server.Id))
        .ToList();

    // 4. å°è¯•æ¢å¤ç¼ºå¤±çš„è¿æ¥
    foreach (var server in missingServers)
    {
        _logger.LogInformation(
            "Recovering missing connection for enabled server {ServerId} ({ServerName})",
            server.Id, server.Name);
        
        await sessionManager.StartSessionAsync(server.Id, cancellationToken);
    }
}
```

**è¦†ç›–åœºæ™¯**:
- âœ… Redis é‡å¯ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰
- âœ… æ‰‹åŠ¨æ¸…ç©º Redis
- âœ… å¯åŠ¨æ—¶è¿æ¥å¤±è´¥ï¼ˆæœªå†™å…¥ Redisï¼‰
- âœ… æ‰‹åŠ¨å¯ç”¨æœåŠ¡å™¨åè¿æ¥åˆ›å»ºå¤±è´¥

**ç¤ºä¾‹æµç¨‹**:
```
T0: Redis é‡å¯ï¼Œæ‰€æœ‰æ•°æ®ä¸¢å¤±
    æ•°æ®åº“: [Server-1 âœ…, Server-2 âœ…, Server-3 âœ…] (IsEnabled=true)
    Redis:  [] (ç©º)

T1 (30ç§’å): ç›‘æ§å¾ªç¯æ£€æµ‹åˆ°ä¸ä¸€è‡´
    [è­¦å‘Š] Found 3 enabled servers in database but missing from Redis
    
T2: å°è¯•æ¢å¤
    [ä¿¡æ¯] Recovering missing connection for enabled server Server-1
    [ä¿¡æ¯] Successfully recovered connection for server Server-1
    [ä¿¡æ¯] Recovering missing connection for enabled server Server-2
    [ä¿¡æ¯] Successfully recovered connection for server Server-2
    [ä¿¡æ¯] Recovering missing connection for enabled server Server-3
    [ä¿¡æ¯] Successfully recovered connection for server Server-3

T3: æ¢å¤å®Œæˆ
    Redis:  [Server-1: Connected, Server-2: Connected, Server-3: Connected] âœ…
```

### 2. å¿ƒè·³æ£€æµ‹æœºåˆ¶

```csharp
// æ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡
private async Task UpdateLocalConnectionHeartbeatsAsync(...)
{
    var localSessions = sessionManager.GetAllSessions();
    
    foreach (var session in localSessions)
    {
        if (session.Value.IsConnected)
        {
            // æ›´æ–° Redis ä¸­çš„å¿ƒè·³æ—¶é—´æˆ³
            await connectionStateService.UpdateHeartbeatAsync(
                session.Key, 
                cancellationToken);
        }
    }
}
```

### 3. åƒµå°¸è¿æ¥æ£€æµ‹

```csharp
// æŸ¥æ‰¾å¿ƒè·³è¶…æ—¶çš„è¿æ¥ (é»˜è®¤ 90 ç§’)
var staleConnections = await connectionStateService
    .GetStaleConnectionsAsync(_heartbeatTimeout, cancellationToken);

foreach (var staleConnection in staleConnections)
{
    // æ¸…ç†è¿‡æœŸçŠ¶æ€
    await connectionStateService.UnregisterConnectionAsync(
        staleConnection.ServerId, 
        cancellationToken);
}
```

### 3. é‡è¿é€»è¾‘

```csharp
// è·å–æ‰€æœ‰æ–­å¼€çš„è¿æ¥
var disconnectedStates = allStates
    .Where(s => s.Status == ConnectionStatus.Disconnected || 
                s.Status == ConnectionStatus.Failed)
    .ToList();

foreach (var disconnectedState in disconnectedStates)
{
    // æ£€æŸ¥å†·å´æœŸ
    var timeSinceDisconnect = DateTime.UtcNow - 
        disconnectedState.LastDisconnectedTime;
    
    if (timeSinceDisconnect < _reconnectCooldown)
        continue; // è¿˜åœ¨å†·å´æœŸå†…ï¼Œè·³è¿‡
    
    // å°è¯•é‡æ–°è¿æ¥ï¼ˆä¼šè‡ªåŠ¨ç«äº‰åˆ†å¸ƒå¼é”ï¼‰
    await sessionManager.StartSessionAsync(
        disconnectedState.ServerId, 
        cancellationToken);
}
```

### 4. åˆ†å¸ƒå¼é”ç«äº‰

```csharp
// åœ¨ McpSessionManager.StartSessionAsync ä¸­
var lockKey = $"mcp:lock:connection:{serverId}";

await using var lockHandle = await _lockService.AcquireLockAsync(
    lockKey,
    expiryTime: TimeSpan.FromMinutes(5),
    waitTime: TimeSpan.FromSeconds(10),  // ç­‰å¾…æœ€å¤š 10 ç§’
    retryTime: TimeSpan.FromSeconds(1),  // æ¯ç§’é‡è¯•ä¸€æ¬¡
    cancellationToken);

if (lockHandle == null || !lockHandle.IsAcquired)
{
    // å¦ä¸€ä¸ªå®ä¾‹å·²ç»åœ¨å¤„ç†è¿™ä¸ªè¿æ¥
    return false;
}

// è·å–é”æˆåŠŸï¼Œå»ºç«‹è¿æ¥
```

---

## æ—¶é—´å‚æ•°é…ç½®

### é»˜è®¤é…ç½®

```json
{
  "ConnectionMonitor": {
    "CheckIntervalSeconds": 30,      // ç›‘æ§æ£€æŸ¥é—´éš”
    "HeartbeatTimeoutSeconds": 90,   // å¿ƒè·³è¶…æ—¶åˆ¤å®š
    "ReconnectCooldownSeconds": 60   // é‡è¿å†·å´æœŸ
  }
}
```

### æ—¶é—´çº¿æ€»ç»“

```
æ•…éšœå‘ç”Ÿ â”€â”€â”€â”€â–º 0 ç§’
  â”‚
  â”œâ”€â–º ç¬¬ 1 æ¬¡æ£€æŸ¥ â”€â”€â”€â”€â–º 30 ç§’ (å¿ƒè·³è¿‡æœŸ 30 ç§’ï¼Œæœªè¶…æ—¶)
  â”‚
  â”œâ”€â–º ç¬¬ 2 æ¬¡æ£€æŸ¥ â”€â”€â”€â”€â–º 60 ç§’ (å¿ƒè·³è¿‡æœŸ 60 ç§’ï¼Œæœªè¶…æ—¶)
  â”‚
  â”œâ”€â–º ç¬¬ 3 æ¬¡æ£€æŸ¥ â”€â”€â”€â”€â–º 90 ç§’ (å¿ƒè·³è¿‡æœŸ 90 ç§’ï¼Œè¶…æ—¶ï¼)
  â”‚                      â””â”€â–º æ¸…ç†åƒµå°¸è¿æ¥
  â”‚
  â”œâ”€â–º ç¬¬ 4 æ¬¡æ£€æŸ¥ â”€â”€â”€â”€â–º 120 ç§’ (å†·å´æœŸ 30 ç§’ï¼Œæœªè¿‡)
  â”‚
  â”œâ”€â–º ç¬¬ 5 æ¬¡æ£€æŸ¥ â”€â”€â”€â”€â–º 150 ç§’ (å†·å´æœŸ 60 ç§’ï¼Œå·²è¿‡ï¼)
  â”‚                      â””â”€â–º å¼€å§‹é‡è¿
  â”‚
  â””â”€â–º è¿æ¥æ¢å¤ â”€â”€â”€â”€â–º 152 ç§’
```

**æ€»æ¢å¤æ—¶é—´**: çº¦ **2-3 åˆ†é’Ÿ** (å¯é€šè¿‡è°ƒæ•´é…ç½®ç¼©çŸ­)

---

## å¿«é€Ÿæ¢å¤é…ç½®

å¦‚æœæ‚¨å¸Œæœ›æ›´å¿«çš„æ•…éšœæ¢å¤ï¼Œå¯ä»¥è°ƒæ•´é…ç½®ï¼š

### å¿«é€Ÿæ¢å¤é…ç½®ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

```json
{
  "ConnectionMonitor": {
    "CheckIntervalSeconds": 10,      // æ›´é¢‘ç¹æ£€æŸ¥
    "HeartbeatTimeoutSeconds": 30,   // æ›´å¿«åˆ¤å®šè¶…æ—¶
    "ReconnectCooldownSeconds": 15   // æ›´çŸ­å†·å´æœŸ
  }
}
```

**æ¢å¤æ—¶é—´**: çº¦ **45-60 ç§’**

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```json
{
  "ConnectionMonitor": {
    "CheckIntervalSeconds": 30,      // æ ‡å‡†æ£€æŸ¥é—´éš”
    "HeartbeatTimeoutSeconds": 90,   // é¿å…è¯¯åˆ¤
    "ReconnectCooldownSeconds": 60   // é¿å…é‡è¿é£æš´
  }
}
```

**æ¢å¤æ—¶é—´**: çº¦ **2-3 åˆ†é’Ÿ**ï¼ˆæ›´ç¨³å®šå¯é ï¼‰

---

## å¤šå®ä¾‹åè°ƒç¤ºä¾‹

### ç¤ºä¾‹ï¼š5 ä¸ªå®ä¾‹ï¼Œ10 ä¸ªè¿æ¥ï¼Œå®ä¾‹ 3 å´©æºƒ

```
åˆå§‹çŠ¶æ€:
å®ä¾‹ 1: Server-1, Server-2
å®ä¾‹ 2: Server-3, Server-4
å®ä¾‹ 3: Server-5, Server-6  â† å´©æºƒ
å®ä¾‹ 4: Server-7, Server-8
å®ä¾‹ 5: Server-9, Server-10

å®ä¾‹ 3 å´©æºƒåï¼š
â”œâ”€ Server-5 å’Œ Server-6 éœ€è¦é‡è¿
â”œâ”€ æ‰€æœ‰å…¶ä»–å®ä¾‹ (1, 2, 4, 5) éƒ½ä¼šæ£€æµ‹åˆ°
â””â”€ é€šè¿‡åˆ†å¸ƒå¼é”ç«äº‰ï¼Œå¯èƒ½çš„ç»“æœï¼š

å¯èƒ½ç»“æœ 1:
å®ä¾‹ 1: Server-1, Server-2, Server-5
å®ä¾‹ 2: Server-3, Server-4
å®ä¾‹ 3: [å´©æºƒ]
å®ä¾‹ 4: Server-7, Server-8, Server-6
å®ä¾‹ 5: Server-9, Server-10

å¯èƒ½ç»“æœ 2:
å®ä¾‹ 1: Server-1, Server-2
å®ä¾‹ 2: Server-3, Server-4, Server-5, Server-6
å®ä¾‹ 3: [å´©æºƒ]
å®ä¾‹ 4: Server-7, Server-8
å®ä¾‹ 5: Server-9, Server-10

(å…·ä½“å–å†³äºå“ªä¸ªå®ä¾‹å…ˆè·å¾—é”)
```

---

## æ•…éšœåœºæ™¯æµ‹è¯•

### æµ‹è¯•åœºæ™¯ 1: å•å®ä¾‹å´©æºƒ

```bash
# å¯åŠ¨ 3 ä¸ªå®ä¾‹
# åœæ­¢å®ä¾‹ 2 (Ctrl+C)
# è§‚å¯Ÿå®ä¾‹ 1 å’Œ 3 çš„æ—¥å¿—
# é¢„æœŸ: 2-3 åˆ†é’Ÿåè¿æ¥è¢«æ¥ç®¡
```

### æµ‹è¯•åœºæ™¯ 2: ç½‘ç»œåˆ†åŒº

```bash
# ä½¿ç”¨é˜²ç«å¢™è§„åˆ™æ¨¡æ‹Ÿç½‘ç»œæ•…éšœ
# è§‚å¯Ÿå…¶ä»–å®ä¾‹çš„è¡Œä¸º
# é¢„æœŸ: å¿ƒè·³è¶…æ—¶åæ¥ç®¡è¿æ¥
```

### æµ‹è¯•åœºæ™¯ 3: å¿«é€Ÿé‡å¯

```bash
# åœæ­¢å®ä¾‹ 2
# åœ¨ 60 ç§’å†…é‡æ–°å¯åŠ¨å®ä¾‹ 2
# é¢„æœŸ: å®ä¾‹ 2 å¯èƒ½é‡æ–°è·å¾—è¿æ¥
```

---

## æ€»ç»“

âœ… **è‡ªåŠ¨æ•…éšœæ¢å¤**: å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„  
âœ… **åˆ†å¸ƒå¼åè°ƒ**: é€šè¿‡ Redis é”é¿å…å†²çª  
âœ… **å¿«é€Ÿæ£€æµ‹**: 90 ç§’å†…æ£€æµ‹åˆ°æ•…éšœ  
âœ… **æ™ºèƒ½é‡è¿**: å†·å´æœŸé¿å…é‡è¿é£æš´  
âœ… **è´Ÿè½½å‡è¡¡**: è¿æ¥è‡ªåŠ¨åˆ†é…åˆ°å¯ç”¨å®ä¾‹  
âœ… **å¯é…ç½®**: æ ¹æ®éœ€æ±‚è°ƒæ•´æ¢å¤æ—¶é—´  

æ‚¨çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼å½“ä¸€ä¸ªæœåŠ¡æŒ‚æ‰åï¼Œå…¶ä»–æœåŠ¡ä¼šè‡ªåŠ¨æ¥ç®¡å¹¶é‡å»ºè¿æ¥ã€‚ğŸ‰
